<html>

<head>

    <META Charset = "utf-8" />

<link rel="stylesheet" type="text/css" class="ui" href="stylesheets/semantic.min.css">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />

<link rel="stylesheet" href="stylesheets/Icon.Label.css" />

<link rel="stylesheet" href="stylesheets/auto20.css" />


<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
<![endif]-->


<style>  

    .mapLabel {
        float: left;
        color: blue;
    }
    .mapPopup {
        width: 400px;
        border-radius: 15px;
        background-color: rgba(255,255,255,0.8); 
    }
</style>

<script src="javascripts/lib/jquery-1.10.2.js"></script>
<script src="javascripts/lib/jquery-ui.js"></script>
<script src="javascripts/lib/underscore-min.js"></script>
<script src="javascripts/lib/backbone-min.js"></script>

<script src="javascripts/lib/tongwen_core.js"></script>
<script src="javascripts/lib/tongwen_table_pt2s.js"></script>
<script src="javascripts/lib/tongwen_table_t2s.js"></script>

<script src='https://cdn.firebase.com/v0/firebase.js'></script>

<script src="javascripts/lib/leaflet-src.js"></script>
<script src="javascripts/lib/leaflet.js"></script>

<script src="http://leaflet.github.io/Leaflet.label/leaflet.label.js"></script>

	<script src="javascripts/lib/Marker.Label.js"></script>
	<script src="javascripts/lib/Icon.Label.js"></script>


<title>自學2.0--地圖式的互助通訊錄</title>

    <script type="text/javascript">        
        function makeTimeStamp(){
            var d = new Date();

            var curr_second = d.getSeconds();
            var curr_minute = d.getMinutes();
            var curr_hour = d.getHours();
            (curr_hour > 12) ? curr_hour = ' 下午 ' + (curr_hour - 12) : curr_hour = ' 上午 ' + curr_hour;
            var curr_date = d.getDate();
            var curr_month = d.getMonth() + 1; //Months are zero based
            var curr_year = d.getFullYear();

            return curr_year +"/" + curr_month + "/" + curr_date + curr_hour + ':' + curr_minute +':'+ curr_second;
        }
    </script>

</head>

<body>

    <div id="searchDiv">            <!-- Point:Search  Status: Usable lev 1-->
        <div id="searchbox">
            <input id="search" type="text" data-ng-modle = "seekFriend" placeholder="輸入關鍵字再按「Go!」找朋友">
            <button id="goSearch">Go!</button>
        </div>
    </div>

    <div id="chatDiv">              <!-- Point:Chat    Status: Demo-->
        <div id="messageDiv">
        </div>
        <div id="chatInputDiv">
            <input type = 'text' id = 'nameInput' placeholder = '輸入您的名字'></input>
            <input type = 'text' id = 'messageInput' placeholder = '輸入您的聊天訊息'></input>
        </div>
    </div>

    <script type="text/javascript">
        var myDataRef = new Firebase('https://shackhand-autolearn.firebaseio.com'); 
            $('#messageInput').keypress(function (e) {
            if (e.keyCode == 13) {
                var name = $('#nameInput').val();
                var text = $('#messageInput').val();
                var time = makeTimeStamp()
                    time = (' -- 0'+time.split('午')[1].replace(' ', '')).replace('011', '11').replace('012', '12');

                myDataRef.child('chat').push({name: name, text: text, time: time});
                myDataRef.child('chatNew').child(makeTimeStamp()).set({name: name, text: text, time: time});
                $('#messageInput').val('');
            }
        });

        myDataRef.child('chat').on('child_added', function(snapshot) {
            var message = snapshot.val();    
            displayChatMessage(message.name, message.text, message.time);
        });

        function displayChatMessage(name, text, time) {
            $('<div/>').text(time).prepend($('<em/>').text(text)).prepend($('<em/>').text(name+': ')).appendTo($('#messageDiv'));
            $('#messageDiv')[0].scrollTop = $('#messageDiv')[0].scrollHeight;
            $('#chatDiv').scrollTop($('#chatDiv').height());
        };

      </script>


    <div id="map">                          <!-- Point: Main-Map   Status: Usable lev0 -->
    </div>

    <div id="join">                         <!-- Point:Form  -->
        <h1>升起您的交友旗幟</h1>

        這份表單是為了自學家庭之間能相互認識，找到彼此。<br /><br />
        如有兩位以上的孩子，請為他們各填一份表單。<br />

<!--        <div id = 'faq'><a>FAQ</a></div>  -->

        <div>

            <h2>*您的名字?</h2>
            <input id = 'name' type = 'text' placeholder = '請輸入你的大名'></input>
            
            <h2>*您的模糊地址?</h2>
            <input id = 'address' type = 'text' placeholder = 'A縣B市C路'></input>

            <h2>*可公開的聯絡方式，
</h2>
            <textarea id = 'connect_me' rows = '5' cols = '30' placeholder = '如有多行，請在分行處加上<br>記號'></textarea>
    

            <h2>*您的網址?</h2>
            <input id = 'site' type = 'text' placeholder = '您的個人網址'></input>
            
            <h2>*您的社群網址?</h2>
            <input id = 'site2' id = 'address' type = 'text' placeholder = '讓別人認識您的社群'></input>


            <h2>*學習者的出生年份(西元)?</h2>
            <input id = 'learner_birth' type = 'text' placeholder = '學習者 = 您或您的孩子'></input>
            
            <h2>*學習者的身份? (複選)</h2>
            <p id = 'learner_role'>                
                <input type = 'checkbox' id = '自學家長'>自學家長</input>
                <input type = 'checkbox' id = '自學生'>自學生</input>
                <input type = 'checkbox' id = '獨立教育工作者'>獨立教育工作者</input><br />
                <input type = 'checkbox' id = '自學團體'>自學團體</input>
                <input type = 'checkbox' id = '自主生活者'>自主生活者</input>
                <input type = 'checkbox' id = '自耕農'>自耕農</input><br />
                <input type = 'checkbox' id = '微型創業者'>微型創業者</input>
            </p>




            <h2>*旗幟的顏色?</h2>
            <p>自學團體=red, 自學家庭=yellow,<br />
                獨立教師=green, 其他朋友=blue</p>
            
            <p id = 'Style'>
                <input name = 'Style' type = 'radio' id = 'large_red'>large_red</input>
                <input name = 'Style' type = 'radio' id = 'large_yellow'>large_yellow</input>
                <input name = 'Style' type = 'radio' id = 'large_green'>large_green</input>
                <input name = 'Style' type = 'radio' id = 'large_blue'>large_blue</input>
            </p>


            <h2>*學習者的興趣?</h2>
            <input id = 'learner_habit' type = 'text' placeholder = '有助於關鍵字搜詢'></input>                      
            <h2>*家庭可以分享、助人的領域?</h2>
            <input id = 'share' type = 'text' placeholder = '有助於別人用關鍵字找到您，尋求支持'></input>                        


            <h2>*家庭希望的支援?</h2>            
            <input id = 'ask' type = 'text' placeholder = '有助於別人用關鍵字找到您，尋求支持'></input>            
            <h2>*公開的自我介紹?</h2>
            <textarea id = 'note' rows = '5' cols = '30' placeholder = '任何可以公開的自我介紹，幫助別人認識你。'></textarea>

            
<!--            <h2>Tags(for Search Engine)</h2>
            <span>ex tag1 <button>x</button></span>
            <input type = 'text' placeholder = 'ex1'></input> <button>Add tag</button> -->            
            <br/>
            <button id = 'formPerview' class = 'ui blue button'>預覽</button>           
            <button id = 'formSubmit' class = 'ui green button'>送出</button>

            <!-- address: 如有兩位以上相同，要修成略有不同，才會分別顯示出兩位的圖示。 -->

        </div>
     </div>

<script>

    var preview = false; var userNum;

    Auto20 = Backbone.View.extend({
        el: $('body'),

        events :{
            'keypress input#search' : 'maybeSearch',
            'click button#goSearch' : 'changeHands',
            'click button#formPerview' : 'formPerview',
            'click button#formSubmit' : 'formSubmit'
        },

        initialize: function() {

            _.bindAll(this, 'feedback', 'maybeSearch','changeHands', 'formPerview', 'formSubmit', 'makePrev', 'render');

            
            this.osmUrl='http://{s}.tile.cloudmade.com/1dc4012079d54f93b27789a1fc4491e9/997/256/{z}/{x}/{y}.png';

            this.cloudmadeAttribution = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade';

            this.LeafIcon = L.Icon.extend({
                    options: {
                        shadowUrl: 'img/leaf-shadow.png',
                        iconSize:     [38, 95],
                        shadowSize:   [50, 64],
                        iconAnchor:   [22, 94],
                        labelAnchor:  [0, 0],
                        shadowAnchor: [4, 62],
                        popupAnchor:  [-3, -76]
                    }
            });

            this.icon = {green: new this.LeafIcon({iconUrl: 'img/leaf-green.png'}),
                        red : new this.LeafIcon({iconUrl: 'img/leaf-red.png'}),
                        orange : new this.LeafIcon({iconUrl: 'img/leaf-orange.png'}),            
                        purple : new this.LeafIcon({iconUrl: 'img/leaf-purple.png'})
                    };

            preview = false;

            if (location.hash.replace('#','').length > 0) {
            	$('input#search').val(decodeURIComponent(location.hash.replace('#','')));

            };



            this.welcomeWord = L.popup().setLatLng([22.01, 123.26]).setContent("<div id = 'welcome' style = 'font-size:2rem'><p>歡迎使用「自學2.0」地圖式互助通訊錄！！</p><p>自學的路不孤單，相信您一定很快能找到志同道合的朋友與共學夥伴👼</p></div>");


            this.render();
        },

        maybeSearch: function(ev) {
            if ( ev.which === 13 ) { 
                this.changeHands();
            }
        },

        changeHands: function() {
            console.log('call changeHands');

            location.hash = '#' + encodeURI($('input#search').val());

            $("#map").fadeOut(1000);

            setTimeout(function() {
                $('#map').remove();
                $('body').append("<div id = 'map'></div>");
                console.log('removeMap');
                eval("auto20.render()");
            }, 2000);

        },

        render: function() {

            var icon = this.icon;
            var osmUrl = this.osmUrl;
            var attribution = this.cloudmadeAttribution;
            var welcomeWord = this.welcomeWord;

            myDataRef.child('hands').once('value', function(dataSnapshot) {
                var markers = [];
                var fMarkers = [];
                var lMarkers = [];
                var eMarkers = [];
                var gMarkers = [];
                var mMarkers = [];  
                var latlngUsed = [];
                var labels = new L.FeatureGroup();

                var autos = dataSnapshot.val();
                userNum = autos.length;

                this.map = L.map('map', {
                    center: new L.LatLng(23.654299340, 120.44776492196047),
                    zoom: 7,
//                    layers: [minimal, hands.a]
                });

                this.map.addLayer(labels);   /* 待把 scr 解決 */

   //              labels.addLayer(
	//					new L.Marker(
	//						getRandomLatLng(this.map),
	//						{ icon: new L.Icon.Label.Default({ labelText: "A label" }), revealing: true }
	//					)
	//				);

                if (preview) {
                	autos =[preview];
                	preview = '';
                	welcomeWord = false;
                }

                for (var i = 0; i < autos.length; i++) {

                    console.log(i);

                    var hand = autos[i];
                    if (!hand.name) {
                        console.log('略過無名氏'); continue
                    }

                    hand.latlngColumn = hand.latlngColumn.replace('(','').replace(')','').replace('附近','');

                    var uniqueLatLng = false;
                    while (!uniqueLatLng) {
                    	uniqueLatLng = true;

	                    for (var j = 0; j < latlngUsed.length; j++) {
	                    	if (latlngUsed[j] == hand.latlngColumn) {
	                    		hand.latlngColumn = hand.latlngColumn + '5';
		                    	uniqueLatLng = false;
		                    	break;
	                    	}
	                    	else {
	                    		latlngUsed.push(hand.latlngColumn)
	                    	}
	                    };
	                }

                    console.log(hand.latlngColumn.split());

                    var colorIcon = icon.orange;

                    console.log(hand.name + hand.Style);
                    switch (hand.Style) {
                        case 'large_green' :
                            colorIcon = icon.green;                    break;
                        case 'large_yellow' :
                            colorIcon = icon.orange;                    break;
                        case 'large_blue' :
                            colorIcon = icon.purple;                    break;
                        case 'large_red' :
                            colorIcon = icon.red;                    break;
                        default:
                            colorIcon = icon.orange;
                    }

                    var seek = $('input#search').val();
                    var seeks = seek.split(/\s+/);
                    console.log(seeks);

//                    var flag = hand.name+"<b>Hello world!</b><br />I am a popup.";
                    var flag = '<div class="flag">'
                        +'<font color = "grey">加入時間: '+hand.時間戳記+'</font><br />'
                        +'<h2> 👪 '+hand.name+'😼</h2><br />'
                        +hand.learner_birth+'年次的'+hand.learner_role+'，住在'+hand.address+'附近<br />'
                        +'<font color = "grey">經緯度: '+hand.latlngColumn+'</font>'
                        +'<br />'
                        +'<a href = "http://map.alearn.org.tw" target ="_blank" title = "更多自學資訊，請上自學地圖"> <img height="100" width="120" src= "http://map.alearn.org.tw/images/automap.jpg" style = "float:right">  </a>'
                        +'<br />'
                        +'<b>網址: </b>'+hand.site+'<br />'
                        +'<b>社群網址: </b>'+hand.site2+'<br />'
                        +'<b>公開的聯絡方式:</b>'+hand.connect_me+'<br />'
                        +'<p align = "center"><b>歡迎聯絡!!</b></p><br />'
                        +'<br />'
                        +'<b>興趣包含:</b>'+hand.learner_habit+'<br />'
                        +'<br />'
                        +'<b>可分享:</b>'+hand.share+'<br />'
                        +'<b>需要:</b>'+hand.ask+'<br />'
                        +'<br />'
                        +'<b>自我介紹:</b>'+hand.note+'<br />'
                        +'<br />'
                        +'<hr>'
                        +'<b> <a href = "mailto:bestianhelp@gmail.com?subject=回報名為'+hand.name+'、時間戳記為'+hand.時間戳記+'的資料錯誤&body=網站管理員您好: 我要回報名為'+hand.name+'的資料錯誤，詳請如下：" title="如遇錯誤與濫用，請按此回報，謝謝!!">  回報錯誤或濫用 </a> </b>'
                        +'</div>'

                    if (seek) {
                        myDataRef.child('seek').child(makeTimeStamp()).set({seek: seek});

                        var seekGood = false;
                        for (var j = 0; j < seeks.length; j++) {
                            var look = seeks[j]
                        	if (seek[j] && flag.search(look) > -1) {
//                                console.log("aaa"+flag.search('高雄'));
                                seekGood = true;
                            }
                        };

                        if (!seekGood) {
                            console.log(seeks.join()+'：'+flag.search(look)+'略過'+hand.name);
                            continue;
                        }

                        if (flag) {
                        	for (var j = 0; j < seeks.length; j++) {
                                var look = seeks[j];
                        		if (look){
                                    console.log(look);
                            //        var re = new RegExp(seek[j],"g");
                                   flag = flag.replace(look,'<span style = "background-color: rgba(255,255,155,1) ">' + look + '</span>')
    	                    	}
                        	};                        
                        }

                    };


                    if (hand.latlngColumn.split(',').length != 2) {
                        console.log('LatLng:'+ hand.latlngColumn);
                        continue;
                    }

                    markers[i] = L.marker(hand.latlngColumn.split(','), {icon: colorIcon }).bindPopup(flag, {
                                className: 'mapPopup' }).bindLabel(hand.name, {
                                    noHide: true,
                                    className: 'mapLabel',
                                    direction: 'auto'
                                    });
					
                   


                    if (hand.learner_role.indexOf('自學家長') > -1) fMarkers.push(markers[i]);
                    if (hand.learner_role.indexOf('自學生') > -1) lMarkers.push(markers[i]);
                    if (hand.learner_role.indexOf('獨立教育工作者') > -1) eMarkers.push(markers[i]);
                    if (hand.learner_role.indexOf('自學團體') > -1) gMarkers.push(markers[i]);


                    var flagT = hand.時間戳記.split('/'); 
                    var nowT = makeTimeStamp().split('/');

    //                console.log(nowT.join());
    //                console.log(flagT.join());
     //               console.log(parseInt(nowT[0]) * 365 + parseInt(nowT[1]) * 30 - (parseInt(flagT[0]) * 365 + parseInt(flagT[1]) * 30));

                    if ( (parseInt(nowT[0]) * 365 + parseInt(nowT[1]) * 30 - (parseInt(flagT[0]) * 365 + parseInt(flagT[1]) * 30)) < 31) {
                        console.log('Pushed')
                        mMarkers.push(markers[i]);
                    }
                };

                var goodMarkers = [];

                for (var i = 0; i < markers.length; i++) {
                    if (!markers[i]) {
                        console.log("null marker:"+i);
                        continue;
                    }
                    goodMarkers.push(markers[i]);
                };

                for (var i = 0; i < goodMarkers.length; i++) {
                    var currentMarker = goodMarkers[i];
//                    currentMarker.on('mouseover', currentMarker.openPopup.bind(currentMarker));

                    currentMarker.on('click', currentMarker.closePopup.bind(currentMarker));
                };

                var hands = {
                 a: L.layerGroup(goodMarkers),  // 所有人           good!
                 f: L.layerGroup(fMarkers),  // 自學家庭         
                 l: L.layerGroup(lMarkers),  // 自學生
                 e: L.layerGroup(eMarkers),  // 教育工作者
                 g: L.layerGroup(gMarkers),  // 自學團體
                 m: L.layerGroup(mMarkers),  // 當月新人
                }


                var minimal = L.tileLayer(osmUrl, {
                    styleId: 113475,
                    attribution: attribution,
                    maxZoom: 18
                }); 
  //            var midnight  = L.tileLayer(osmUrl, {
  //                  styleId: 113784,
  //                  attribution: attribution,
  //                  maxZoom: 18
  //              });


  //              var baseMaps = {
  //                  "白天": minimal,
  //                  "黑夜": midnight    //bug here-- 沒有連到樣式
  //              };


                this.overlayMaps = {
                    "自學家庭": hands.f,
                    "自學生": hands.l,
                    "獨立教育工作者": hands.e,
                    "自學團體": hands.g,
                    "顯示當月新人": hands.m,         
                    "顯示全部": hands.a,
                };

         //       this.allMaps = {           
      //          }

                this.map.addLayer(minimal);
                this.map.addLayer(hands.a);
                


                L.control.layers(this.overlayMaps).addTo(this.map);  // 之後可以設圖層：家庭, 教師, 自學團體

                function getRandomLatLng(map) {
									var bounds = map.getBounds(),
										southWest = bounds.getSouthWest(),
										northEast = bounds.getNorthEast(),
										lngSpan = northEast.lng - southWest.lng,
										latSpan = northEast.lat - southWest.lat;

									return new L.LatLng(
										southWest.lat + latSpan * Math.random(),
										southWest.lng + lngSpan * Math.random()
									);
								}

//				for (var j = 0; j < 20; j++) {
//					labels.addLayer(
//						new L.Marker(
//							getRandomLatLng(this.map),
//							{ icon: new L.Icon.Label.Default({ labelText: "A label" }) }
//						)
//					);
//				};


                hands.a.eachLayer(function (marker) {
                    marker.showLabel();
                });


                if (welcomeWord) {
        //            welcomeWord.openOn(this.map);
                    this.welcomeWord = '';
                 }

                $( this.el ).scrollTop( 0 );



                console.log("render finished");

            });

        },

        formPerview: function() {    //預覽
            this.makePrev('changeHands');
        },

        formSubmit: function() {    //送出表單
         	this.makePrev('formSubmit');
        },

        makePrev: function(command) {

        	console.log("preview started");

        	$.getJSON( "http://query.yahooapis.com/v1/public/yql?q=select+%2A+from+geo.placefinder+where+text%3D%22"+ $('#address').val() +"%22+and+locale%3D%22zh_TW%22&format=json", function( data ) {

        		console.log(data);

        		var lat = data.query.results.Result.latitude;
        		var lng = data.query.results.Result.longitude;
        		var latlngColumn = lat+','+lng;

        		console.log(latlngColumn);

            	var timeStamp = makeTimeStamp();

            	var roles = ['自學家長','自學生','自學團體','獨立教育工作者','自主生活者','自耕農','微型創業者'], goodRoles = [];
	            for (var i = 0; i < roles.length; i++) {
	                if (document.getElementById(roles[i]).checked) goodRoles.push(roles[i]);
	            };

	             var styles = ['large_red','large_yellow','large_green','large_blue'], goodStyle = '';

	            for (var i = 0; i < styles.length; i++) {
	                if (document.getElementById(styles[i]).checked) { goodStyle = styles[i]; break }
	            };

	            preview = {
	                時間戳記: timeStamp,
	                name: $('#name').val(),
	                address: $('#address').val(),
	                latlngColumn : latlngColumn,
	                connect_me: $('#connect_me').val(),
	                site: $('#site').val(),
	                site2: $('#site2').val(),
	                learner_birth: $('#learner_birth').val(),
	                learner_role: goodRoles.join(),
	                Style: goodStyle,
	                learner_habit: $('#learner_habit').val(),
	                share: $('#share').val(),
	                ask: $('#ask').val(),
	                note: $('#note').val(),
	            };

            	console.log(preview);

            	if(command == 'changeHands') {	            	
	                eval("auto20.changeHands()");
	            	return;
	            }

	            if(command == 'formSubmit') {

	            	var keys = Object.keys(preview);

	            	for (var i = 0; i < keys.length; i++) {
	            		if (!preview[keys[i]]) {alert('請輸入'+keys[i]); return};
	            	};

		         	if (preview.note.length < 20) {alert('請輸入完整的自我介紹'); return};

		            mydataRef.child('hands').child(userNum).set(preview);
		            preview = false;
		            
	                eval("auto20.changeHands()");
	            }
        	});            
        },

        feedback: function() {
        },



    });
    
    var auto20 = new Auto20();
    
    
        

</script>

</body>


</hmtl>
