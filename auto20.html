<html>

<head>

    <meta name="viewport" content="width=device-width">

    <META Charset = "utf-8" />

<link rel="stylesheet" type="text/css" class="ui" href="stylesheets/semantic.min.css">
<link rel="stylesheet" href="Leaflet.iconlabel-master/lib/leaflet-dist/leaflet.css" />


    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />


<link rel="stylesheet" href="Leaflet.iconlabel-master/dist/leaflet.iconlabel.css" />
<link rel="stylesheet" href="Leaflet.iconlabel-master/src/Icon.Label.css" />
<link rel="stylesheet" href="stylesheets/auto20.css" />

<!--  Todo: åŒæ–‡å ‚ -->



<style>

    .mapLabel {
    	text-align: center;
        color: rgba(0,0,0,1);
        background-color: rgba(255,255,255,1);
        max-width: 7rem;
        max-height: 1rem;
        overflow: hidden;
    }
    .mapLabel:hover {
        background-color: rgba(200,255,255,1);
        font-size: 1.1rem;
        max-width: 420px;
        max-height: 15rem;
    }

    .leaflet-clickable:hover {
        z-index: 99999; /* important */
    }

    .mapPopup {
 /*       width: 400px;
        border-radius: 15px;
        background-color: rgba(255,255,255,0.8); */
    }

    #warning {
        display: block;
        position: relative;
        top: 100px; left: 100px;
        font-size: 3rem;
        color: rgba(100,100,100,1);
    }
    #warning > a{
        color: rgba(100,100,100,1);
    }
</style>

<script src="javascripts/lib/jquery-1.10.2.js"></script>
<script src="javascripts/lib/jquery-ui.js"></script>
<script src="javascripts/lib/underscore-min.js"></script>
<script src="javascripts/lib/backbone-min.js"></script>

<script src="javascripts/lib/tongwen_core.js"></script>
<script src="javascripts/lib/tongwen_table_pt2s.js"></script>
<script src="javascripts/lib/tongwen_table_t2s.js"></script>

<script src='https://cdn.firebase.com/v0/firebase.js'></script>

<!--
<script src="javascripts/lib/leaflet-src.js"></script>
<script src="javascripts/lib/leaflet.js"></script> -->

<script src="Leaflet.iconlabel-master/lib/leaflet-dist/leaflet.js"></script>
<script src="Leaflet.iconlabel-master/lib/leaflet-dist/leaflet-src.js"></script>

<!--<script src="http://leaflet.github.io/Leaflet.label/leaflet.label.js"></script> -->

	<script src="javascripts/lib/Marker.Label.js"></script>
	<script src="javascripts/lib/Icon.Label.js"></script>
    <script src="javascripts/lib/Icon.Label.Default.js"></script>
    <script src="Leaflet.iconlabel-master/dist/leaflet.iconlabel.js"></script>

<title>è‡ªå­¸2.0--åœ°åœ–å¼çš„äº’åŠ©é€šè¨ŠéŒ„</title>

    <script type="text/javascript">        
        function makeTimeStamp(){
            var d = new Date();

            var curr_second = d.getSeconds();
            var curr_minute = d.getMinutes();
            var curr_hour = d.getHours();
            (curr_hour > 12) ? curr_hour = ' ä¸‹åˆ ' + (curr_hour - 12) : curr_hour = ' ä¸Šåˆ ' + curr_hour;
            var curr_date = d.getDate();
            var curr_month = d.getMonth() + 1; //Months are zero based
            var curr_year = d.getFullYear();

            return curr_year +"/" + curr_month + "/" + curr_date + curr_hour + ':' + curr_minute +':'+ curr_second;
        }
    </script>

</head>

<body>

    <div id="searchDiv">            <!-- Point:Search  Status: Usable lev 1-->
        <div id="searchbox">
            <input id="search" type="text" data-ng-modle = "seekFriend" placeholder="è¼¸å…¥é—œéµå­—å†æŒ‰ã€ŒGo!ã€æ‰¾æœ‹å‹">
            <button id="goSearch">Go!</button>
        </div>
    </div>

    <div id="chatDiv">              <!-- Point:Chat    Status: Demo-->
        <div id="messageDiv">
        </div>
        <div id="chatInputDiv">
            <input type = 'text' id = 'nameInput' placeholder = 'è¼¸å…¥åå­—æˆ–ç•¶guest'></input>
            <input type = 'text' id = 'messageInput' placeholder = 'è¼¸å…¥æ‚¨çš„èŠå¤©è¨Šæ¯'></input>
        </div>
    </div>

    <script type="text/javascript">

        var myDataRef = new Firebase('https://shackhand-autolearn.firebaseio.com'); 
            $('#messageInput').keypress(function (e) {
            if (e.keyCode == 13) {
                var name = $('#nameInput').val();
                if (!name) name = 'guest';
                var text = $('#messageInput').val();
                
                var time = makeTimeStamp();                
                time = (' -- 0'+time.split('åˆ')[1].replace(' ', '')).replace('011', '11').replace('012', '12');

                myDataRef.child('chat').push({name: name, text: text, time: time});
                myDataRef.child('chatNew').child(makeTimeStamp()).set({name: name, text: text, time: time});

                $('#messageInput').val('');
       //        if ($('#nameInput').val() == '[log]') $('#nameInput').val('');
            }
        });

        myDataRef.child('chat').on('child_added', function(snapshot) {
            var message = snapshot.val();    
            displayChatMessage(message.name, message.text, message.time);
        });


        myDataRef.child('chat').on('child_changed', function(snapshot) {
            var message = snapshot.val();
            displayChatMessage(message.name, message.text, message.time);
        });


        function displayChatMessage(name, text, time) {

            $('#messageDiv').append("<br />" + name + ' ï¼š ' + text + time);

  //          $('<div/>').text(time).prepend($('<em/>').text(text)).prepend($('<em/>').text(name+': ')).appendTo($('#messageDiv'));

            $('#messageDiv').scrollTop = $('#messageDiv').scrollHeight;
            $('#chatDiv').scrollTop($('#chatDiv').height() + 1000);
        };

      </script>

  <!--  <div id="news"></div>  -->

    <div id="backUp">            <!-- Point:Backup  Status: Usable lev 1-->
 
        <button id="goBackUp" onclick = "location = 'https://shackhand-autolearn.firebaseio.com/.json?print=pretty&format=export&download=shackhand-autolearn-export.json'">å‚™ä»½.jsonè³‡æ–™</button>
    </div>


    <div id="map">                          <!-- Point: Main-Map   Status: Usable lev0 -->
        <div id = "warning">æœ¬åœ°åœ–ä¸æ”¯æ´IEç€è¦½å™¨<br/>è‹¥ç„¡æ³•é¡¯ç¤ºï¼Œè«‹æ”¹ç”¨<a href = "http://moztw.org/firefox/" target = "_blank">Firefoxç€è¦½å™¨</a><br/>è¬è¬æ‚¨çš„æ”¯æŒã€‚</div>

        <script type="text/javascript">
            $('#warning').hide();
            setTimeout(function(){$('#warning').show();}, 10000);
        </script>
    </div>

    <div id="join">                         <!-- Point:Form  -->
        <h1>å‡èµ·æ‚¨çš„äº¤å‹æ——å¹Ÿ</h1>

        æœ¬åœ°åœ–ç‚ºé©åˆè¦ªå­ä½¿ç”¨çš„äº’èªå¹³å°ã€‚
        é€™ä»½è¡¨å–®æ˜¯ç‚ºäº†è‡ªå­¸å®¶åº­ä¹‹é–“èƒ½ç›¸äº’èªè­˜ï¼Œæ‰¾åˆ°å½¼æ­¤ã€‚<br /><br />

<!--        <div id = 'faq'><a>FAQ</a></div>  -->

        <div>

            <h2>*æ‚¨çš„åå­—?</h2>
            <input id = 'name' type = 'text' placeholder = 'è«‹è¼¸å…¥ä½ çš„å¤§å'></input>
            
            <h2>*æ‚¨çš„æ¨¡ç³Šåœ°å€?</h2>
            <input id = 'address' type = 'text' placeholder = 'Aç¸£Bå¸‚Cè·¯'></input>

            <h2>*å¯å…¬é–‹çš„è¯çµ¡æ–¹å¼ï¼Œ
</h2>
            <textarea id = 'connect_me' rows = '5' cols = '30' placeholder = 'å¦‚æœ‰å¤šè¡Œï¼Œè«‹åœ¨åˆ†è¡Œè™•åŠ ä¸Š<br>è¨˜è™Ÿ'></textarea>
    

            <h2>*æ‚¨çš„ç¶²å€?</h2>
            <input id = 'site' type = 'text' placeholder = 'æ‚¨çš„å€‹äººç¶²å€'></input>
            
            <h2>*æ‚¨çš„ç¤¾ç¾¤ç¶²å€?</h2>
            <input id = 'site2' id = 'address' type = 'text' placeholder = 'è®“åˆ¥äººèªè­˜æ‚¨çš„ç¤¾ç¾¤'></input>


            <h2>*å­¸ç¿’è€…çš„å‡ºç”Ÿå¹´ä»½(è¥¿å…ƒ)?</h2>
            <input id = 'learner_birth' type = 'text' placeholder = 'ç¨‹å¼æœƒç”±å¹´æ¬¡è‡ªå‹•è¨ˆç®—æ­²æ•¸'></input>
            
            <h2>*å­¸ç¿’è€…çš„èº«ä»½? (è¤‡é¸)</h2>
            <p id = 'learner_role'>                
                <input type = 'checkbox' id = 'è‡ªå­¸å®¶é•·'>è‡ªå­¸å®¶é•·</input>
                <input type = 'checkbox' id = 'è‡ªå­¸ç”Ÿ'>è‡ªå­¸ç”Ÿ</input>
                <input type = 'checkbox' id = 'ç¨ç«‹æ•™è‚²å·¥ä½œè€…'>ç¨ç«‹æ•™è‚²å·¥ä½œè€…</input><br />
                <input type = 'checkbox' id = 'è‡ªå­¸åœ˜é«”'>è‡ªå­¸åœ˜é«”</input>
                <input type = 'checkbox' id = 'è‡ªä¸»ç”Ÿæ´»è€…'>è‡ªä¸»ç”Ÿæ´»è€…</input>
                <input type = 'checkbox' id = 'è‡ªè€•è¾²'>è‡ªè€•è¾²</input><br />
                <input type = 'checkbox' id = 'å¾®å‹å‰µæ¥­è€…'>å¾®å‹å‰µæ¥­è€…</input>
            </p>




            <h2>*æ——å¹Ÿçš„é¡è‰²?</h2>
            <p>è‡ªå­¸åœ˜é«”=red, è‡ªå­¸å®¶åº­=yellow,<br />
                ç¨ç«‹æ•™å¸«=green, å…¶ä»–æœ‹å‹=blue</p>
            
            <p id = 'Style'>
                <input name = 'Style' type = 'radio' id = 'large_red'>large_red</input>
                <input name = 'Style' type = 'radio' id = 'large_yellow'>large_yellow</input>
                <input name = 'Style' type = 'radio' id = 'large_green'>large_green</input>
                <input name = 'Style' type = 'radio' id = 'large_blue'>large_blue</input>
            </p>


            <h2>*å­¸ç¿’è€…çš„èˆˆè¶£?</h2>
            <input id = 'learner_habit' type = 'text' placeholder = 'æœ‰åŠ©æ–¼é—œéµå­—æœè©¢'></input>                      
            <h2>*å®¶åº­å¯ä»¥åˆ†äº«ã€åŠ©äººçš„é ˜åŸŸ?</h2>
            <input id = 'share' type = 'text' placeholder = 'æœ‰åŠ©æ–¼åˆ¥äººç”¨é—œéµå­—æ‰¾åˆ°æ‚¨ï¼Œå°‹æ±‚æ”¯æŒ'></input>                        


            <h2>*å®¶åº­å¸Œæœ›çš„æ”¯æ´?</h2>            
            <input id = 'ask' type = 'text' placeholder = 'æœ‰åŠ©æ–¼åˆ¥äººç”¨é—œéµå­—æ‰¾åˆ°æ‚¨ï¼Œå°‹æ±‚æ”¯æŒ'></input>            
            <h2>*å…¬é–‹çš„è‡ªæˆ‘ä»‹ç´¹?</h2>
            <textarea id = 'note' rows = '5' cols = '30' placeholder = 'ä»»ä½•å¯ä»¥å…¬é–‹çš„è‡ªæˆ‘ä»‹ç´¹ï¼Œå¹«åŠ©åˆ¥äººèªè­˜ä½ ã€‚'></textarea>

                        
            <br/>
            <button id = 'formPerview' class = 'ui blue button'>é è¦½</button>           
            <button id = 'formSubmit' class = 'ui green button'>é€å‡º</button>


        </div>
     </div>

<script>

//    var preview = false;

    var userNum;

    AutoModel = Backbone.Model.extend({
            defaults: {
                    preview: false,
                    welcome: true,
                    search: '',
                    centerZoom: {
                        center: new L.LatLng(23.054299340, 120.24776492196047),
                        zoom: 7, // 4
                        minZoom: 0,
                        maxZoom: 16,
                    },
                    showType: 'a'
                },
            initialize: function(model) {
 //               alert('aaa');
            },
    });

    Auto20 = Backbone.View.extend({
        el: $('body'),

        events: {
            'keypress input#search' : 'maybeSearch',
            'click button#goSearch' : 'maybeSearch',
            'click button#formPerview' : 'formPerview',
            'click button#formSubmit' : 'formSubmit'
        },

        model: new AutoModel(),

        initialize: function() {

            _.bindAll(this, 'feedback', 'maybeSearch','changeHands', 'formPerview', 'formSubmit', 'makePrev', 'render');

  //          this.model.bind('change:search', this.changeHands);
  //          this.model.bind('change:preview', this.changeHands);
            this.model.bind('change:centerZoom', this.changeHands);

            this.osmUrl = 'http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png';
            
     //       this.osmUrl='http://{s}.tile.cloudmade.com/1dc4012079d54f93b27789a1fc4491e9/997/256/{z}/{x}/{y}.png';

            this.cloudmadeAttribution = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade';   

            this.welcomeWord = L.popup().setLatLng([22.01, 118.26]).setContent("<div id = 'welcome' style = 'font-size:2rem'><p>æ­¡è¿ä½¿ç”¨ã€Œè‡ªå­¸2.0ã€åœ°åœ–å¼äº’åŠ©é€šè¨ŠéŒ„ï¼ï¼</p><p>è‡ªå­¸çš„è·¯ä¸å­¤å–®ï¼Œç›¸ä¿¡æ‚¨ä¸€å®šå¾ˆå¿«èƒ½æ‰¾åˆ°å¿—åŒé“åˆçš„æœ‹å‹èˆ‡å…±å­¸å¤¥ä¼´ğŸ‘¼</p></div>");

            $('button#formSubmit').hide();


            if (!location.hash) this.render();
        },

        maybeSearch: function(ev) {
            console.log(ev.target);
            if ( ev.which === 13 || $(ev.target).attr('id') == 'goSearch' ) {
                      
                location.hash = '#' + encodeURI($('#search').val());
            }
        },

        changeHands: function() {

            console.log('call changeHands');

            $("#map").fadeOut(1000);

       ///     alert('aaa');

            setTimeout(function() {
                $('#map').remove();
//                $('.leaflet-clickable').remove();    Todo

                $('body').append("<div id = 'map'></div>");
                console.log('removeMap');
                auto20.render();

            }, 2000);

        },

        render: function() {  //change

            var osmUrl = this.osmUrl;
            var attribution = this.cloudmadeAttribution;
            var welcomeWord = this.welcomeWord;

            var centerZoom = this.model.get('centerZoom');
            var preview = this.model.get('preview');
            var welcome = this.model.get('welcome');

            var seek = this.model.get('search');
         //   var seek = $('input#search').val();
            var seeks = seek.split(/\s+/);
    //        console.log(seeks);

            var showType = this.model.get('showType');

            myDataRef.child('hands').once('value', function(dataSnapshot) {
                var markers = [];
                var fMarkers = [];
                var lMarkers = [];
                var eMarkers = [];
                var gMarkers = [];
                var mMarkers = [];  
                var latlngUsed = [];
                var labels = new L.FeatureGroup();


                var autos = dataSnapshot.val();
                var map = L.map('map', centerZoom);


                if (preview) {
                	autos = [preview];
                	welcomeWord = false;
                }

                for (var i = 0; i < autos.length; i++) {

                    if (!autos[i]) {
                        console.log('ç•¥éç©ºæ ¼'); continue
                    }

                    var hand;

                    !autos[i][1] ? hand = autos[i] : hand = autos[i][autos[i].length -1]; // check autos[i] æ˜¯ä¸æ˜¯ä¸€å€‹é™£åˆ—

                    if (!hand.name) {
                        console.log('ç•¥éç„¡åæ°'); continue
                    }

                    if (hand.site && hand.site.indexOf('http') == -1 && hand.site.indexOf('@') == -1) hand.site = 'http://' + hand.site;

                    if (hand.site.indexOf('@') > -1) {
                    	hand.site = '<a href = "mailto:'+hand.site+'?subject=æ‚¨å¥½&body='+hand.name+'æ‚¨å¥½ï¼šæˆ‘åœ¨è‡ªå­¸2.0ä¸Šçœ‹åˆ°æ‚¨çš„äº¤å‹æ——å¹Ÿï¼Œæˆ‘æ˜¯">'+hand.site+'</a>';
                    }
                    else {
	                    hand.site = hand.site.replace(/(.*?)(http.+)\s*/, '$1 <a href = $2> $2 </a>');
	                }

                    if (hand.site2 && hand.site2.indexOf('http') == -1) hand.site2 = 'http://' + hand.site2;

                
                    hand.latlngColumn = hand.latlngColumn.replace('(','').replace(')','').replace('é™„è¿‘','');

                    
                    hand.age = parseInt(makeTimeStamp().split('/')[0]) - parseInt(hand.learner_birth.split(',')[0].split('å¹´')[0].split('/')[0].substr(0,4));
                    if (hand.age == 0) hand.age = 1;
                    if (!hand.age) {
                        hand.ageMark = ''
                    }
                    else {
                        hand.ageMark = '(' + hand.age + 'æ­²)';
                    }

                    hand.connect_me = hand.connect_me.replace(/(\S+@\S+)/,'<a href = "mailto:$1?subject=æ‚¨å¥½&body='+hand.name+'æ‚¨å¥½ï¼šæˆ‘åœ¨è‡ªå­¸2.0ä¸Šçœ‹åˆ°æ‚¨çš„äº¤å‹æ——å¹Ÿï¼Œæˆ‘æ˜¯"> $1 </a>');


                    var flag = '<div class="flag">'
                        +'<font color = "grey">åŠ å…¥æ™‚é–“: '+hand.æ™‚é–“æˆ³è¨˜+'</font><br />'
                        +'<h2> ğŸ‘ª '+hand.name+'ğŸ˜¼</h2><br />'
                        +hand.learner_birth+'å¹´æ¬¡çš„'+hand.learner_role+'ï¼Œä½åœ¨'+hand.address+'é™„è¿‘<br />'
                        +'<font color = "grey">ç¶“ç·¯åº¦: '+hand.latlngColumn+'</font>'
                        +'<br />'
                        +'<a href = "http://map.alearn.org.tw" target ="_blank" title = "æ›´å¤šè‡ªå­¸è³‡è¨Šï¼Œè«‹ä¸Šè‡ªå­¸åœ°åœ–"> <img height="100" width="120" src= "http://map.alearn.org.tw/images/automap.jpg" style = "float:right">  </a>'
                        +'<br />'
                        +'<b>ç¶²å€: </b>'+hand.site+'<br />'
                        +'<b>ç¤¾ç¾¤ç¶²å€: </b><a href = '+hand.site2+'>'+hand.site2+'</a><br />'
                        +'<b>å…¬é–‹çš„è¯çµ¡æ–¹å¼:</b>'+hand.connect_me+'<br />'
                        +'<p align = "center"><b>æ­¡è¿è¯çµ¡!!</b></p>'
                        +'<b>èˆˆè¶£åŒ…å«:</b>'+hand.learner_habit+'<br />'
                        +'<br />'
                        +'<b>å¯åˆ†äº«:</b>'+hand.share+'<br />'
                        +'<b>éœ€è¦:</b>'+hand.ask+'<br />'
                        +'<br />'
                        +'<b>è‡ªæˆ‘ä»‹ç´¹:</b>'+hand.note+'<br />'
                        +'<br />'
                        +'<hr>'
                        +'<b> <a href = "mailto:bestian@gmail.com?subject=å›å ±åç‚º'+hand.name+'ã€æ™‚é–“æˆ³è¨˜ç‚º'+hand.æ™‚é–“æˆ³è¨˜+'çš„è³‡æ–™éŒ¯èª¤&body=ç¶²ç«™ç®¡ç†å“¡æ‚¨å¥½: æˆ‘è¦å›å ±åç‚º'+hand.name+'çš„è³‡æ–™éŒ¯èª¤ï¼Œè©³è«‹å¦‚ä¸‹ï¼š" title="æ›´æ–°è³‡æ–™ï¼Œæˆ–æ˜¯é‡åˆ°éŒ¯èª¤èˆ‡æ¿«ç”¨ï¼Œè«‹æŒ‰æ­¤å›å ±ï¼Œè¬è¬!!">  æ›´æ–°è³‡æ–™æˆ–æ˜¯å›å ±éŒ¯èª¤ </a> </b>'
                        +'</div>'


                    if (seek) {
                        myDataRef.child('seek').child(makeTimeStamp()).set({seek: seek});

                        var seekGood = false;
                        for (var j = 0; j < seeks.length; j++) {
                            var look = seeks[j]
                        	if (seek[j] && flag.search(look) > -1) {
//                                console.log("aaa"+flag.search('é«˜é›„'));
                                seekGood = true;
                            }
                        };

                        if (!seekGood) {
       //                     console.log(seeks.join()+'ï¼š'+flag.search(look)+'ç•¥é'+hand.name);
                            continue;
                        }

                        console.log(seek + hand.name);
	                    if (seek == hand.name) {
		                    welcomeWord.setContent(flag);
	                    	welcome = true;
		                }

                        else if (flag) {
                        	for (var j = 0; j < seeks.length; j++) {
                                var look = seeks[j];
                        		if (look){
             //                      console.log(look);
                                   var re = new RegExp(look, 'g');
                                   flag = flag.replace(re,'<span style = "background-color: rgba(255,255,155,1) ">' + look + '</span>');
    	                    	}
                        	};                        
                        }


                    };

                    if (!hand.latlngColumn) {
                        console.log('Error: Null LatLng:' + i + 'th');
                        continue;
                    }

                    if (hand.latlngColumn.split(',').length != 2) {
      //                  console.log('LatLng:'+ hand.latlngColumn);
                        continue;
                    }

                    //é‡è¦†åº§æ¨™çš„è§£æ±ºï¼Œå¾…æ¸¬   displacement algorithm

                    var counter = 0;
                    for (var j = 0; j < latlngUsed.length; j++) {
                        if (latlngUsed[j] == hand.latlngColumn) counter++ ;
                    };

                    function modifyLatLng (latlngColumn, counter) {   //  "lat,lng"
                        var lat = parseFloat(latlngColumn.split(',')[0]);
                        var lng = parseFloat(latlngColumn.split(',')[1]);

                        var r = counter / 1000;
                        var theta = counter * Math.PI / 12;

                        var lngOffSet = r * Math.cos(theta);    // x
                        var latOffSet = r * Math.sin(theta) / 2;    // y

                        console.log(latOffSet + ',' + lngOffSet);

                        return ((lat + latOffSet) + ',' + (lng + lngOffSet));
                    }

                    latlngUsed.push(hand.latlngColumn);
                    if (counter > 0) hand.latlngColumn = modifyLatLng(hand.latlngColumn, counter);


        //            console.log(hand.latlngColumn.split());

                    
                    
                    var color = {Url: 'img/leaf-green.png', h: 70};

    //                console.log(hand.name + hand.Style);

                    switch (hand.Style) {
                        case 'large_green' :
                            color.Url = 'img/leaf-green.png';
               //             color.h = 50;
             //               color.w = 50;
                            break;
                        case 'large_yellow' :
                            color.Url = 'img/leaf-yellow.png';               break;
                        case 'large_blue' :
                            color.Url = 'img/leaf-purple.png';               break;
                        case 'large_red' :
                            color.Url = 'img/leaf-red.png';
            //                color.h = 100;
                            break;
                        default:
                            color.Url = 'img/leaf-green.png';
                    }

                    var SweetIcon = L.Icon.Label.extend({
                        options: {
               //             iconUrl: colorUrl,
                  //          shadowUrl: 'img/leaf-green.png',
                            iconSize: new L.Point(35, color.h),
                            iconAnchor: new L.Point(-11, -1-color.h),
                            labelAnchor: new L.Point(20, 20-color.h),
                            wrapperAnchor: new L.Point(12, 13),
                            labelClassName: 'mapLabel'
                        }
                    });

                    markers[i] = new L.Marker(
                            new L.LatLng(
                                        hand.latlngColumn.split(',')[0],
                                        hand.latlngColumn.split(',')[1]
                                    ),
                            { icon: new SweetIcon({ iconUrl: color.Url, labelText: hand.name
                             + hand.ageMark
                             + '<br/>èˆˆè¶£ï¼š' + hand.learner_habit
                            				+ '<br/>åˆ†äº«ï¼š' + hand.share
                            				+ '<br/>éœ€è¦ï¼š' + hand.ask

                             + '<br/>' + hand.site                                      
                             + '<br/>' + hand.connect_me}) }
                        ).bindPopup(flag, {
                                className: 'mapPopup' });
			
 
                    if (hand.learner_role.indexOf('è‡ªå­¸å®¶é•·') > -1) fMarkers.push(markers[i]);
                    if (hand.learner_role.indexOf('è‡ªå­¸ç”Ÿ') > -1) lMarkers.push(markers[i]);
                    if (hand.learner_role.indexOf('ç¨ç«‹æ•™è‚²å·¥ä½œè€…') > -1) eMarkers.push(markers[i]);
                    if (hand.learner_role.indexOf('è‡ªå­¸åœ˜é«”') > -1) gMarkers.push(markers[i]);


                    var flagT = hand.æ™‚é–“æˆ³è¨˜.split('/'); 
                    var nowT = makeTimeStamp().split('/');

     //               console.log(nowT.join());
    //                console.log(flagT.join());
     //               console.log(parseInt(nowT[0]) * 365 + parseInt(nowT[1]) * 30 - (parseInt(flagT[0]) * 365 + parseInt(flagT[1]) * 30));

                    if ( (parseInt(nowT[0]) * 365 + parseInt(nowT[1]) * 30 - (parseInt(flagT[0]) * 365 + parseInt(flagT[1]) * 30)) < 31) {
           //             console.log('Pushed to monthyly newer')
                        mMarkers.push(markers[i]);
                    }
                };

                var goodMarkers = [];

                for (var i = 0; i < markers.length; i++) {
                    if (!markers[i]) {
        //                console.log("null marker:"+i);
                        continue;
                    }
                    goodMarkers.push(markers[i]);
                };

                for (var i = 0; i < goodMarkers.length; i++) {
                	console.log(goodMarkers[i]);
                    labels.addLayer(goodMarkers[i]);
                };

                var hands = {
                 a: labels,  // æ‰€æœ‰äºº           good!
                 f: L.layerGroup(fMarkers),  // è‡ªå­¸å®¶åº­         
                 l: L.layerGroup(lMarkers),  // è‡ªå­¸ç”Ÿ
                 e: L.layerGroup(eMarkers),  // æ•™è‚²å·¥ä½œè€…
                 g: L.layerGroup(gMarkers),  // è‡ªå­¸åœ˜é«”
                 m: L.layerGroup(mMarkers),  // ç•¶æœˆæ–°äºº
                }


                var minimal = L.tileLayer(osmUrl, {
                    styleId: 113475,
                    attribution: attribution,
                    maxZoom: 20
                }); 
  //            var midnight  = L.tileLayer(osmUrl, {
  //                  styleId: 113784,
  //                  attribution: attribution,
  //                  maxZoom: 20
  //              });


                var baseMaps = {
                    "ç™½å¤©": minimal,
  //                  "é»‘å¤œ": midnight    //bug here-- æ²’æœ‰é€£åˆ°æ¨£å¼
                };


                this.overlayMaps = {
                    "è‡ªå­¸å®¶åº­": hands.f,
                    "è‡ªå­¸ç”Ÿ": hands.l,
                    "ç¨ç«‹æ•™è‚²å·¥ä½œè€…": hands.e,
                    "è‡ªå­¸åœ˜é«”": hands.g,
                    "é¡¯ç¤ºç•¶æœˆæ–°äºº": hands.m,         
                    "é¡¯ç¤ºå…¨éƒ¨": hands.a,
                };


         //       if(!change) 
                map.addLayer(minimal);

           //     if(!change) 
                map.addLayer(hands[showType]);  

             //   if(!change) 
             L.control.layers(baseMaps, this.overlayMaps).addTo(map);


                if (!userNum) {
                    userNum = autos.length;
                }

                if (welcome) {
                	welcomeWord.openOn(map);
                	welcome = false;
                }

               $( "body").scrollTop( 0 );


                console.log("render finished");

            });

        },

        formPerview: function() {    //é è¦½

            $('button#formSubmit').show();
            this.makePrev('changeHands');
        },

        formSubmit: function() {    //é€å‡ºè¡¨å–®
            $('button#formSubmit').hide();
         	this.makePrev('formSubmit');
        },

        makePrev: function(command) {

        	console.log("preview started");

        	$.getJSON( "http://query.yahooapis.com/v1/public/yql?q=select+%2A+from+geo.placefinder+where+text%3D%22"+ $('#address').val() +"%22+and+locale%3D%22zh_TW%22&format=json", function( data ) {

        		console.log(data);

        		var lat = data.query.results.Result.latitude;
        		var lng = data.query.results.Result.longitude;
        		var latlngColumn = lat+','+lng;

        		console.log(latlngColumn);

            	var timeStamp = makeTimeStamp();

            	var roles = ['è‡ªå­¸å®¶é•·','è‡ªå­¸ç”Ÿ','è‡ªå­¸åœ˜é«”','ç¨ç«‹æ•™è‚²å·¥ä½œè€…','è‡ªä¸»ç”Ÿæ´»è€…','è‡ªè€•è¾²','å¾®å‹å‰µæ¥­è€…'], goodRoles = [];
	            for (var i = 0; i < roles.length; i++) {
	                if (document.getElementById(roles[i]).checked) goodRoles.push(roles[i]);
	            };

	           var styles = ['large_red','large_yellow','large_green','large_blue'], goodStyle = '';

	            for (var i = 0; i < styles.length; i++) {
	                if (document.getElementById(styles[i]).checked) { goodStyle = styles[i]; break }
	            };

	            var preview = {
	                æ™‚é–“æˆ³è¨˜: timeStamp,
	                name: $('#name').val(),
	                address: $('#address').val().replace(/\d+æ¨“$/, '').replace(/\d+è™Ÿ$/, ''),
	                latlngColumn : latlngColumn,
	                connect_me: $('#connect_me').val(),
	                site: $('#site').val(),
	                site2: $('#site2').val(),
	                learner_birth: $('#learner_birth').val(),
	                learner_role: goodRoles.join(),
	                Style: goodStyle,
	                learner_habit: $('#learner_habit').val(),
	                share: $('#share').val(),
	                ask: $('#ask').val(),
	                note: $('#note').val(),
	            };

            	console.log(preview);

            	if(command == 'changeHands') {	

                    auto20.model.set({ preview: preview  });

                //    if (location.hash != '#'+encodeURI('focus/'+preview.address))
                    //    { 

                    location.hash = '#'+encodeURI('focus/'+preview.address)
                    
               //     }
                 //   else {
                        auto20.changeHands();
                   // };

	            	return;

	            }

	            if(command == 'formSubmit') {
	            	
	            	var autos;
                    var isNew;

	            	myDataRef.child('hands').once('value', function(dataSnapshot) {
	            		autos = dataSnapshot.val();
	            		
	            		if (autos[autos.length - 1].name == preview.name) {
	            			userNum = autos.length -1;
                            isNew = false;
		            	}
		            	else {
		            		userNum = autos.length;
                            isNew = true;
		            	}
	            	

		            	var keys = Object.keys(preview);
	
		            	for (var i = 0; i < keys.length; i++) {
		            		if (!preview[keys[i]]) {alert('è«‹è¼¸å…¥'+keys[i]); return};
		            	};
	

			        if (preview.note.length < 20) {alert('è«‹è¼¸å…¥å®Œæ•´çš„è‡ªæˆ‘ä»‹ç´¹'); return};
	
		                if (!lat) {
		                    alert('åœ°å€æœ‰èª¤ï¼Œè«‹æ ¡å°ç­†èª¤');
		                    return;
		                }
		                else {
		
		    		    myDataRef.child('hands').child(userNum).set(preview);
		
		                    var log = preview.name + "ç™»ä¸Šè‡ªå­¸2.0äº†!! <a href = '#near/"+preview.address + "'>å‰å¾€èªè­˜</a>";
		
		
		                    var time = makeTimeStamp();                
		                    time = (' -- 0'+time.split('åˆ')[1].replace(' ', '')).replace('011', '11').replace('012', '12');


		                    if (isNew) {

                                chatlog = myDataRef.child('chat').push();

                                chatlog.set({name: '[log]', text: log, time: time});
    		                    
                                chatNewlog = myDataRef.child('chatNew').child(makeTimeStamp());

    		                    chatNewlog.set({name: '[log]', text: log, time: time});

                            }
                            else {
                                chatlog.update({name: '[log]', text: log, time: time});
                                chatNewlog.update({name: '[log]', text: log, time: time});
                            }
		
		                    auto20.model.set({ preview: false });
		                    location.hash = '#'+encodeURI('focus/'+preview.address);	
		                    auto20.changeHands();
		
		                }
	                	
	            	});
	            }
        	});            
        },

        feedback: function() {
        },



    });

    
var auto20 = new Auto20();

var Router = Backbone.Router.extend({
  routes: {
    "search/:keys" : "search",
    "focus/:addr" : "focus",
    "near/:addr" : "near",
    "show/:type" : "show",
    "get/:addr" : "get",
    "update/:num" : "update",
    ":word" : "maybe"
  },
 
  search: function(keys) {
    $('input#search').val(decodeURIComponent(keys.split('/')[0]));
    auto20.model.set({ search: keys, welcome: false });

    console.log("search:"+ keys);
    auto20.changeHands();
  },

  focus: function(addr, num, command) {

    if(!num) num = 12;
    if(!command) command = '#focus/';

    $.getJSON( "http://query.yahooapis.com/v1/public/yql?q=select+%2A+from+geo.placefinder+where+text%3D%22"+ addr +"%22+and+locale%3D%22zh_TW%22&format=json", function( data ) {

            var lat = data.query.results.Result.latitude;
            var lng = data.query.results.Result.longitude;

            location.hash = command + encodeURI(addr);
            $('input#search').val(decodeURIComponent(addr));

            try {
                map.setView(new L.LatLng(lat, lng), num);
            }
            catch(err) {
                auto20.model.set( {centerZoom : {
                            center: new L.LatLng(lat, lng),
                            zoom: num },
                            search: '',
                            welcome: false });
            };
        });
  },

  near: function (addr) {
    this.focus(addr, 14,'#near/');
  },


  show: function (type) {
    auto20.model.set( {showType : type, welcome: false } );
    auto20.changeHands();
  },

  get: function(addr) {
    $.getJSON( "http://query.yahooapis.com/v1/public/yql?q=select+%2A+from+geo.placefinder+where+text%3D%22"+ addr +"%22+and+locale%3D%22zh_TW%22&format=json", function( data ) {

            var lat = data.query.results.Result.latitude;
            var lng = data.query.results.Result.longitude;

            console.log(lat+','+lng);
            location.hash = '#get/'+(lat+','+lng);
      });
  },

  update: function(num) {
     if (!confirm("æ‚¨ç¢ºå®šæ˜¯æœ¬äººï¼Œè¦ä¿®æ”¹æ——å¹Ÿå—ï¼Ÿ")) return;

     // æŠŠèˆŠè³‡æ–™æ”¾é€²previewå»
        // datasnapshot once
            // $(input#...).val(hand.name) -> 
            // $(input#...).val(hand.address) ->
            //...

     // previewä¹‹å¾Œï¼Œä¸é¡¯ç¤ºé€å‡ºéˆ•ï¼Œå¦é¡¯ç¤ºä¸€å€‹æ–°çš„ã€Œæ›´æ–°éˆ•ã€
     

     // æŠŠfirebaseä¸Šçš„Data, å¦‚æœæ˜¯å–®å€¼ï¼Œå°±å…ˆè®Šæˆå–®å…ƒç´ é™£åˆ—

     // æŠŠé™£åˆ—å¾Œé¢åŠ ä¸Šæ–°å…ƒç´ 
        // var version = array.length
        // æœ€å¾Œ myDataRef.child('hands').child(num).child(version).update(preview);

  },

  maybe: function (word){

    if (/^[amfleg]$/.test(word)) {location.hash = '#show/' + encodeURI(word); return}

    $('input#search').val(word);

    $.getJSON( "http://query.yahooapis.com/v1/public/yql?q=select+%2A+from+geo.placefinder+where+text%3D%22"+ word +"%22+and+locale%3D%22zh_TW%22&format=json", function( data ) {

            var obj; try { obj = data.query.results.Result; } catch (e) {
         	
                location.hash = '#search/' + encodeURI(word);
            };
            console.log(obj);

            if(!data.query.results.Result.latitude) {
                location.hash = '#search/' + encodeURI(word);
                return;
            }

            else {

                var checklist = ['line1','line2','line3','line4'];

                for (var i = 0; i < checklist.length; i++) {
                    if (!obj[checklist[i]]) continue;
                    if (obj[checklist[i]].replace(word,'').length < 3) {

                        if (word.length < 4) {
                            location.hash = '#focus/' + encodeURI(word);
                        }
                        else {
                            location.hash = '#near/' + encodeURI(word);
                        }
                        return;
                    }
                };

                location.hash = '#search/' + encodeURI(word);
                return;
            }

      });         
  },


   // æ¸¬è©¦ä¸­çš„åŠŸèƒ½

   stick: function(latLng) {
        var lat = latLng.split(',')[0];
        var lng = latLng.split(',')[1];

        $('input#search').val('');
        location.hash = '#stick/'+ lat + ',' + lng;

        lyMap.model.set( {centerZoom : {
                        center: new L.LatLng(lat, lng),
                        zoom: 11 } });
   },

});
 
var yC = new this.Router;
 
Backbone.history.start();
    
    
       // æ¸¬è©¦ä¸­çš„åŠŸèƒ½
function focusOn(position) {
    console.log( '#stick/'+ position.coords.latitude + ',' +  position.coords.longitude );
    location.hash = '#stick/'+ position.coords.latitude + ',' +  position.coords.longitude;
}   
    
   // æ¸¬è©¦ä¸­çš„åŠŸèƒ½
function getLocation()  {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(focusOn);
    }
    else {
        console.log("Geolocation is not supported by this browser.");
    }
}
   // æ¸¬è©¦ä¸­çš„åŠŸèƒ½

// getLocation();
        

</script>

</body>


</hmtl>
