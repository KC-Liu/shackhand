

<!-- backbround image colored bots -->

<!-- li icons before -->



<!DOCTYPE html>
<html ng-app = "editApp">

<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="javascripts/lib/angular.min.js"></script>

<script src='https://cdn.firebase.com/v0/firebase.js'></script>
<script src='https://cdn.firebase.com/libs/angularfire/0.5.0/angularfire.min.js'></script>


<meta charset=utf-8 />

<title>自學計畫編輯器。可列印和存檔。</title>


<link rel="stylesheet" href="stylesheets/editor.css" />

<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css">


<style>

#headInfos {
  position: absolute;
  top: 0px;
  left: 0px;
  width: 100%;
  height: 30px;
  background-color: #cc9;
  text-align: center;
  overflow: auto;
  border: green 1px ridge;
}

#headInfos *{
  max-height: 28px;

}

#headInfos #unlock,#lock,#create,#delete,#main a {
  display: inline-block;
  border: green 1px ridge;
  background-color: #afa;
  cursor: pointer;
  border-radius: 5px 0 5px 0;
}



#headPlans{
  display: block;
  position: absolute;
  top: 31px;
  left: 200px;
  width: 50%;
  min-height: 20px;
  background-color: rgba(255,255,255,0.2);
  text-align: center;
  border-radius: 0 0 10px 10px ;
  padding-top: 5px;
}

#headPlans a{
  display: inline-block;
  border: 1px black solid;
  min-width: 30px;
  margin-left: 15px;
  border-radius: 10px 10px 0 0;
  background: #eee;
}


#headPlans a.focus {
  border: 2px black solid;
  border-bottom: none;
  background: #fff;
}


span#status {
  display: inline-block;
  color: #eee;
}


#leftPages {
  display: block;
  position: absolute;
  left: 0px;
  top: 31px;
  width: 200px;
  min-height: 100%;
  background-color: #cc9;
  padding-right: 2px;
}


#leftPages li, #rightSupports li{
  margin-top: 30px;
  display: block; 
  border: 1px black solid;
  border-radius: 10px 0 10px 0;
  background-color: #eee; 
  padding: 2px;
  cursor: pointer;
  text-align: center;
}

#leftPages li:hover, #leftPages li.focus, #rightSupports li:hover {
  border: 2px black solid;
  background-color: #fff; 
  border-right: none;
  margin-right: -10px;
}

#rightSupports {
  display: block;
  position: absolute;
  top: 30px;
  right: 0px;
  width: 200px;
  min-height: 100%;
  background-color: #cc9;
  border: 1px black solid;
  border-radius: 10px 0 0 10px ;
  padding: 5px;
  -webkit-transition: all .3s ease;
  -moz-transition: all .3s ease;
  -ms-transition: all .3s ease;
  -o-transition: all .3s ease;
  transition: all .3s ease;
}

#rightSupports:hover {
  width: 300px;
  z-index: 99;
  cursor: help;
}

#main {
  position: absolute;
  background: #fff;
  top: 55px;
  left: 205px;
  width: 210mm;
  height: 297mm;
  padding: 10px;
  display: block;
  border-radius: 0px 15px 15px 0px;
}

tr {
  min-height: 20px;
}
th,td {
   min-width: 20px;
}

a#x, #x {
  cursor: not-allowed; 
}

img.shadow {
  position:relative; left:-24px;
}

#popup-content {
  display: block;
  background: #fff;
  position: fixed;
  width: 80%;
  height: 80%;
  top: 10%;
  left: 10%;
  z-index: 98;
}

#popup-content * {
  position: relative;
  z-index: 99;
}

</style>

</head>




<body ng-controller = "Ctrl">

  <audio id ="easy" controls autoplay>
    <source src="voice/easy.mp3" type="audio/mpeg">
    <source src="voice/easy.ogg" type="audio/ogg">
  </audio>



<div id = 'headInfos' class = 'noPrint'>

  使用者名稱(ID)：
  <input ng-model = 'name' />
 <!-- 密碼(Password)：<input type = 'password' ng-model = 'password' /> -->
  
  <a id = 'unlock' ng-click = 'unlock' ng-hide = 'logged'>解鎖</a>
  <a id = 'lock' ng-click = 'lock' ng-show = 'logged'>上鎖</a>

<!--
  <a id = 'create' ng-click = 'create' ng-hide = 'logged'>創建帳號</a>
  <a id = 'delete' ng-click = 'create' ng-show = 'logged'>刪除帳號</a>
-->

  <span id = 'status' ng-show = 'logged'>可編輯</span>
  <span id = 'status' ng-show = 'name == "您"'>沙盒</span>
  <span id = 'status' ng-hide = 'logged || name == "您"'>只可瀏覽</span>

  <span id = 'lastTime'>上次編輯時間: {{root.data.time}} </span>

</div>


<div id = 'headPlans' class = 'noPrint'>

  <span ng-repeat = 'n in [0,1,2,3,4,5,6,7,8,9,10,11]'>

    <span id = 'init1' ng-init = "root.data.t[n]['自傳'] = root.data.t[n]['自傳'] || hint['自傳']"></span>

    <span id = 'init2' ng-init = ""></span>


    <span id = 'init3' ng-init = "
    root.data.t[n]['主題'] = ['生活自理','運動','閱讀','寫作','參訪'];
    root.data.t[n].correlation = {'健康與體育運動': true}">
  </span>


    <span id = 'init4' ng-init = ""></span>


    <a class = "{{$parent.planNow == n && 'focus'}}" ng-mouseover = '$parent.planNow = n; quite();'>
      {{n+1}}
    </a>

  </span>

</div>


<!---->


<div id = 'leftPages' class = 'noPrint'>

  <ul>
    <li ng-repeat = "k in ['自傳', '學習風格','學習主題與領域','一週節奏','學期進度表','學習空間與支持','學習資源','希望的協助','附件']" class = "{{$parent.pageNow == k && 'focus'}}" ng-mouseover = '$parent.pageNow = k;quite()'> 

      <img src="img/leaf-yellow.png" />
      <img src="img/leaf-shadow.png" class="shadow"/> 

      <br/>
      {{name}}的{{ k }} </li>
  </ul>

</div>

<!---->


<div id = 'rightSupports' class = 'noPrint'>

<h3>{{pageNow}}</h3>
<br/>參考資源：
  <hr>
<ul>
	<li ng-repeat = "sup in supports | has:pageNow | invis:pageNow " ng-click = "op(sup.split(' ')[1])" ng-mouseover = "$parent.pop = true; $parent.popURL = sup.split(' ')[1]">

    <img src="img/leaf-green.png"  />
      <img src="img/leaf-shadow.png" class="shadow"/>

      <br/>

    {{sup.split(' ')[0]}}
</ul>

</div>



<div id = 'main'>

  <span id = 'status' ng-show = 'updated'>所有更動已儲存</span>
  <span id = 'status' ng-hide = 'updated'>等待儲存...</span>
  <span id = 'status' ng-show = 'justDeleted'>本頁已刪除</span>

  <div id ='page1' ng-show = "pageNow == '自傳'">

    學習的Timeline
    <hr>
	  <textarea rows= '22' cols = '52' ng-model = "root.data.t[planNow]['自傳']"  

    ng-focus = " root.data.t[planNow]['自傳'] = hintToNull(root.data.t[planNow]['自傳']) "

    ng-blur = "root.data.t[planNow]['自傳'] = root.data.t[planNow]['自傳'] || hint['自傳'] "
    >


    </textarea>
  </div>

  <div id ='page2' ng-show = "pageNow == '學習風格'">

    <table>
      <tr>
        <td>
      	  <textarea rows= '22' cols = '32' ng-model = 'root.data.t[planNow]["學習風格"]'> </textarea>
        </td>
        <td>
          學習風格自我測試
          <div > {{root.data.t[planNow].styleTester1}} </div>

          學習階段自我測試
          <div > {{root.data.t[planNow].styleTester2}} </div>
        </td>
      </tr>
    </table>

  </div>


  <div id ='page3' ng-show = "pageNow == '學習主題與領域'">

    <audio id ="topic" controls>
            <source src="voice/topic.mp3" type="audio/mpeg">
            <source src="voice/topic.ogg" type="audio/ogg">
    </audio>


    <input ng-model = "addTopic" ng-keydown = "adTPC($event)" placeholder = "寫上主題，再按Enter鍵"/>

<!--  <a ng-click= "adTPC($event)">增加主題</a> -->

      <span ng-repeat = "t in root.data.t[planNow]['主題']"> <a id = "x" ng-click = "root.data.t[planNow]['主題'] = removeElem(root.data.t[planNow]['主題'], t)">{{t}}</a></span>

      <br>
          
      <span id = "x" onclick = "$(this).fadeOut()" onmouseover = "$('#topic').trigger('play')">
        <ul>
          <li>您的學習主題可以自訂好幾項，範圍不限。
          <li>例如修車、養昆蟲、寫程式、打籃球、繪畫...都可以。
          <li>先想自己要做什麼，再去和課綱上的七大領域，對照打勾，看看是不是都有。
          <li>如果同一個主題，和許多領域都有關，可以在一行中，打好幾個勾。</ul> </span>

      <hr>

        <table>
           <tr>
            <th>
            <span id = "status" ng-show = "count(root.data.t[planNow].correlation, sevenFields, root.data.t[planNow]['主題']) > 0">還有{{count(root.data.t[planNow].correlation, sevenFields, root.data.t[planNow]['主題'])}}個領域</span>

            <span id = "status" ng-hide= "count(root.data.t[planNow].correlation, sevenFields, root.data.t[planNow]['主題']) > 0">都對到了!!</span>
            </th>

            <th ng-repeat = "t in root.data.t[planNow]['主題']"> {{t}}</th>
           </tr>
           <tr ng-repeat = "a in sevenFields">
            <th>{{a}}</th>
              <td ng-repeat = "t in root.data.t[planNow]['主題']">
              <input type = "checkbox" ng-model ="root.data.t[planNow].correlation[a+t]" /> 
              <span class = "clipOnly"> {{ root.data.t[planNow].correlation[a+t] && "V" || ''}} </span>
           </tr>
        </table>
  </div>


  <div id ='page4' ng-show = "pageNow == '一週節奏'">

    你不一定要只在家裡或社區，自學生也可以規畫一部份時間，在學校上課。
    不僅可以規畫在原本的學校上課，也可以去任何一所公立大學旁聽。政府的政策是，所有公立大學都開放旁聽。

  </div>


  <div id = 'action'>
  	目前頁面是：{{pageNow}}

    {{name}}要：
    <a id = 'save' ng-click = "save()">雲端儲存</a>還是
    <a id = 'delete' ng-click = "deleteData(pageNow)">清空</a>呢?
    <br/>
    <hr>
    <br/>
    小幫手：<a id = 'save' ng-click = "save()">雲端儲存</a>的資料，將會用於協助其他計劃自學的人。
    <br/>
    如您不願分享，請在編輯完成後，剪貼存下副本，再<a id = 'delete' ng-click = "deleteData(pageNow)">清空</a>雲端資料。
  </div>

</div>




<div id='popup-content' popup='popURL' ng-show = "pop" ng-mouseout = "pop = false">

  <iframe id ="myframe" width = "100%" height = "100%">

  </iframe>

</div>






</body>


<script type="text/javascript">



  var editApp = new angular.module('editApp',["firebase"]);
  editApp.filter('has',function(){
  	return function(list, x){
//  		console.log(x);
  		return list.filter(function(str){return (str.indexOf(x) > -1) || (str.indexOf('all') > -1) })
  	}
  }).filter('invis',function(){
    return function(list, x){
//      console.log(x);
      return list.map(function(str){return str.replace(x+',', '').replace('all,', '')});
    }
  })
.directive('popup', function() {
  var p = {
      link : function(scope, iElement, iAttrs){
           //code to wrap the div (iElement) with a abs pos div (parentDiv)
          // code to add a mask layer div behind 
          // if the parent is already there, then skip adding it again.
         //use jquery ui to make it dragable etc.
          scope.$watch(iAttrs.popup, function(newVal, oldVal){
               if(newVal){
       //            $(iElement).show();
                   console.log(newVal);
                   $('#myframe').attr('src', newVal);
                 } 
              else{
         //        $(iElement).hide();
                }
          });
      }


   }
  return p;
});

  var Ctrl = function ($scope, $firebase) {

  	$scope.confirm = window.confirm;
    $scope.console = window.console;
  	$scope.$ = jQuery;
    $scope.popURL = '';
    $scope.name = '您';
    $scope.planNow = 0;
    $scope.pageNow = '自傳';
    $scope.sevenFields = ['語文-國文','語文-鄉土語文','語文-英文','健康與體育','社會','數學','自然與科技','藝術與人文','綜合活動'];

    $scope.hint = {
      自傳: '小幫手：先照著你想到的去寫你的成長故事以及自我介紹\n\n再對應到申請書的「個性描述」「平時興趣」「健康狀況」「學習態度」「家庭成員」「家庭成員」「人際互動」「特殊表現」「其他方面」'
    };

           $scope.root = {};
           $scope.root.data = {};
           $scope.root.data.t = [
            {},   //0
            {},
            {},
            {},
            {},   //4
            {},
            {},
            {},
            {},  
            {},  //9
            {},
            {},  //11
            ];
            for (var i = 0; i < $scope.root.data.t.length; i++) {
              $scope.root.data.t[i].correlation = $scope.root.data.t[i].correlation || {};
            };

            $scope.len =  $scope.root.data.t.length;


    $scope.supports = [
    '全球化與自主學習(自傳,13分鐘_講座) http://www.youtube.com/embed/Mi7qkTyqimE',
    '各縣市自學申請表(附件,_正式申請用的表格是這份喔!) http://law.chen-wernik.net',
    '學習風格自我測試(學習風格,5分鐘_自我探索) http://bestian.github.io/freemath/%E5%B7%A5%E5%85%B7%E8%BB%9F%E9%AB%94/styleTester.html',
    '七大領域的教學理念(學習主題與領域,3分鐘_瀏覽概要) http://163.24.138.110/jses/other/%E4%B8%83%E5%A4%A7%E9%A0%98%E5%9F%9F%E7%9A%84%E6%95%99%E5%AD%B8%E7%90%86%E5%BF%B5.html',
    '如何訂學習計畫_上(學習主題與領域,10分鐘_講座) http://www.youtube.com/embed/SUoT5P8_UOI',
    '如何訂學習計畫_中(學習主題與領域,10分鐘_講座) http://www.youtube.com/embed/2jF8Hu6aTCU',
    '如何訂學習計畫_下(學習主題與領域,10分鐘_講座) http:www.youtube.com/embed/yeWB3BhQ7lg',
    '如何成為未來職場需要的自由人才_上(學習主題與領域,10分鐘_講座) http://www.youtube.com/embed/ZPzqw3x05-g',
    '如何成為未來職場需要的自由人才_中(學習主題與領域,10分鐘_講座) http://www.youtube.com/embed/Yc-fHn5aevo',
    '如何成為未來職場需要的自由人才_中(學習主題與領域,10分鐘_講座) http://www.youtube.com/embed/IqQTLQH-S_M',
    '丙級技術師證照線上複習(學習主題與領域,3分鐘_瀏覽概要) http://onlinetest.slhs.tp.edu.tw/test2/main/review_setup.asp?examid=testr',
    '乙級技術師證照線上複習(學習主題與領域,3分鐘_瀏覽概要) http://onlinetest2.slhs.tp.edu.tw'

    ];



    $scope.deleteData = function (pageNow) {
	    if (confirm('確認刪除?這動作無法復原')) $scope.root.data.t[pageNow] = '';
	  }

    $scope.removeElem = function(list, elem) {
       return list.filter(function(str){ return str.indexOf(elem) == -1})
    }

    $scope.adTPC = function(ev){
      if ((ev.keyCode && ev.keyCode != 13) || !$scope.addTopic) return;
      $scope.root.data.t[$scope.planNow]['主題'].push($scope.addTopic);
      $scope.addTopic = '';
    }

    $scope.count = function(table, set1, set2) {

   //   console.log(table);
   //   console.log(set1);
   //   console.log(set2);

      var ans = set1.length;

      function satis(elem) {
        var a = false;
        for (var i = 0; i < set2.length; i++) {
          if (table[elem+set2[i]]) a = true;
        };
        return a;

      }
      for (var i = 0; i < set1.length; i++) {
        if (satis(set1[i])) ans -= 1;
      };

      return ans;
    }

    $scope.quite = function() {
      $("audio").each(function(){
          this.pause(); // Stop playing
          this.currentTime = 0; // Reset time
      }); 
    }

     $scope.hintToNull = function(str) {
      if (!str) return;
      return str.substr(0,4) == '小幫手：' ?  ''  : str;
    }

    $scope.op = function(url) {
      window.open(url);
    }

    $scope.save = function () {

      function createPassword() {
        var p1, p2;
        while (!p1 || p1 != p2) {
          p1 = prompt("請輸入密碼");
          p2 = prompt("請再輸入一次密碼以確認");

          if (p1 != p2) { alert("兩次密碼不同，請重新設定") } else { break }
        }
        alert("已成功設定密碼為"+p1+"請確實記下您的密碼，之後無法再查詢。");
        return p1 && p2;
      }

      if ($scope.name != '您')  {
        if ($scope.root.password) {
          var trypass = prompt("請輸入密碼以儲存變更");
          if (trypass != $scope.root.password) {
            alert("密碼不符");
            return;
          }

        } else {
          var newPass = createPassword();
          $scope.root.$child(password).$set(newPass);
        }
      }

      var d = new Date;
  //    console.log(d.toLocaleString());

 //     console.log($scope.base);

      $scope.root.data.time = d.toLocaleString();

      $scope.base.$set($scope.root);

      $scope.updated = true;

    }


    $scope.id = function(o) {
      var m = {};
      for (i=0; i < Object.keys(o).length; i++) {
          var k = Object.keys(o)[i];
        m[k] = o[k];
      } 
      console.log("A"); 
      console.log(m);
      return m;
    }

      $scope.$watch('name', function(newValue, oldValue) {    // chage firebase ref when name changed
        console.log("I see a data change!" + newValue);

        $scope.updated = false;

        var ref = new Firebase('https://shackhand-plan.firebaseio.com/' + encodeURI(newValue));

        $scope.base = $firebase(ref);

        $scope.base.$on("change", function() {
          console.log("A remote change was applied locally!");

          setTimeout( function() {   
            $scope.overwrite();
          }, 500);

          setTimeout( function() {
              if (!$scope.binding) {
                $scope.bind3w();
              } else {
                console.log("Binded");
              }
          }  , 1000 );

        });
       
    });


    $scope.overwrite = function() {  
        if (JSON.stringify($scope.base.data) != JSON.stringify($scope.root.data)) {
          $scope.root.data = $scope.id($scope.base.data);
        } else {
          console.log("same!");
        }

        console.log("B"); 
        console.log($scope.root) ;   
    }

    $scope.bind3w = function() {

              console.log("C"); 
              console.log($scope.base);       
              

          //    $scope.$watch("root", function(oldValue,newValue) {
           //             alert("root data synced !");
                       //   console.log($scope.base);
             //             $scope.base.$set(newValue);
            //          });
              
              setInterval(function(){
                  setTimeout ( function () {
                    $scope.base.$set($scope.root);
                    console.log("pushed");
                  }, Math.random() * 10);
              }, 100);

              $scope.binding = true;
              $scope.updated = true;

       //       $scope.base.$bind($scope, "root");


    }

  };


</script>

</html>
