
<!DOCTYPE html>
<html ng-app = "listApp">

<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.min.js"></script>
<meta charset=utf-8 />

<title>自學支持與學習資源。可列印。</title>

<style id="cardStyles" type="text/css">

/******************************************************************************
* Styles for playing cards.                                                   *
******************************************************************************/



body {
  background-color: #40a040;
}


#page {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  width: 210mm;
  height: 297mm;
  background-color: #ffffff;
  z-index: -1;
}

#page:hover {
  z-index: 99;
}

form {
  z-index: 1;
  background: rgba(200, 200, 200, 0.5);
 /* width: 20%; */
  height: 297mm;  
  width: 50%;
  top: 0;
  right: 0;
  border-radius: 5px;
  padding: 5px 15px;
  position: absolute;
  -webkit-transition: all .3s ease;
  -moz-transition: all .3s ease;
  -ms-transition: all .3s ease;
  -o-transition: all .3s ease;
  transition: all .3s ease;
}


form:hover {
    background: rgba(200, 200, 200, 1);

}

input {
  font-size: 120%;
  color: rgba(0,0,0,0.7);
}

#doPrint {
  font-size: 150%;  
}

@media print {

  body {
    background-color: #ffffff;
    width: 210mm;
  }

  .noPrint, .noPrint *{
  	display: none;
  }

  #header {
    height: 0px;
    display: none;
  }

  #page #main {
    position: absolute;
    top: 0px;
  }  

}

.qr {
  display: inline-block;
  width: 20mm;
}

#ord, .num {
	max-width: 25mm;
}

#header {
  display: inline-block;
  height: 150px;
}

.small {
  font-size: 70%;
}

ul li {
  text-align: right;
}

</style>

</head>


<body ng-controller = "Ctrl">

<!--
<div id = "whiteback">
  <hr style="position:absolute; bottom: 0mm; width:100%; "> 
</div>

-->



<form id="frm" class = "noPrint">

  <hr>

      <div id = "custom" class="noPrint"> 
        
        <ul>

        <li ng-repeat = "gift in gifts | useKey:key | useKey:keyLocal | useKey:keySpecial | useKey:keySelect | useKey:yesAge |  useKey:no:1 | useKey:noSelect:1 | useKey:noAge:1 ">
            	<input type="checkbox" ng-model = "gift.checked">
            	
   				
            {{gift.title}}      
            <span class = "small">
            <a href = "http://{{ gift.url | makeQR }}" target = "_blank">
              {{ gift.url | makeQR }}
            </a>

            <br/>
            {{gift.tags}}  <input id = "ord" class="noPrint" type = "number" ng-model = "gift.ord" ng-init = "gift.ord = gifts.indexOf(gift)">    
            </span>

          <hr>
        </li>

        </ul>

      </div>

    </form>




<div id = "page" class="print" style="font-size: {{size}}pt"> 
  
    <div id = "header" class="noPrint">
      <button id = "doPrint" class="noPrint" onclick="window.print()">列印紙本</button>

      <span>自訂字級：</span>
  <input type = "number" class = "num" ng-model ="size" ng-init = " size = 14 ">
    <span>顯示標籤上限：</span>
  <input type = "number" class = "num"  ng-model ="tagsLimit" ng-init = " tagsLimit = 6">
  <br/>
    <input type="checkbox" ng-model = "qr" ng-init = "qr = true">
    <span>顯示QR碼&nbsp;&nbsp;&nbsp;&nbsp;</span>
    <span>標號類別</span>
    <select name = "ol" ng-model = "ol" ng-init = "ol = 'cjk-ideographic'">
      <option value="cjk-ideographic">cjk-ideographic</option>
      <option ng-repeat = "op in ['circle','square','disk','decimal','lower-roman','upper-roman','lower-alpha','upper-alpha','lower-greek']" value="{{op}}">{{op}}</option>
    </select>

  <hr>
    <span>包含：</span>
  <input type = "search" ng-model ="key" placeholder = "輸入關鍵字">

    <select name = "yes" ng-model ="keyLocal">
      <option value = "">--地理位置--</option>
      <option ng-repeat = "tag in local_taiwan" value = "{{tag}}">{{tag}}</option>
    </select>

    <select name = "yes" ng-model ="keySpecial">
      <option value = "">--特教支持--</option>
      <option ng-repeat = "tag in special_edu" value = "{{tag}}">{{tag}}</option>
    </select>

    <select name = "yes" ng-model ="keySelect">
      <option value = "">--所有標籤--</option>
      <option ng-repeat = "tag in tags" value = "{{tag.t}}">{{tag.t}}({{tag.n}})</option>
    </select>
    
    <select name = "yesAge" type = "number" ng-model ="yesAge">
      <option value = "">--年齡--</option>
      <option ng-repeat = "age in ages" value = "{{age}}">{{age}}歲</option>
    </select>
  
  <hr>  
    <span>不包含：</span>
  <input type = "search" ng-model ="no" ng-init = "no = '付費'">

    <select name = "no" ng-model ="noSelect">      
      <option value = "">--所有標籤--</option>
      <option ng-repeat = "tag in tags" value = "{{tag.t}}">{{tag.t}}({{tag.n}})</option>
    </select>

    <select name = "noAge" type = "number" ng-model ="noAge">
      <option value = "">--年齡--</option>
      <option ng-repeat = "age in [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]" value = "{{age}}">{{ age}}歲</option>
    </select>
    <hr>

    </div>
 
    <div id = "main">

      <ol style="list-style-type: {{ol}}">
        <li ng-repeat = "gift in gifts | checked | sortByOrd">
         
            {{gift.title}}
            <a href = "http://{{ gift.url | makeQR }}" target = "_blank">
              {{ gift.url | makeQR  }}
            </a>

            <span id = "tags"> {{gift.tags | limitTag:tagsLimit | addQuote }}</span>    
            
            <span ng-show = "qr && gift.url">

                <a href = "http://{{gift.url | makeQR}}" target="_blank">

                  <img class = "qr" src="http://chart.apis.google.com/chart?chs=200x200&amp;cht=qr&amp;chld=|1&amp;chl=http%3A%2F%2F{{gift.url | makeQR}}%2F" alt="qrcode_ex" >

                </a>  </span>

        </li>

        <li ng-hide = "(gifts | checked | sortByOrd).length > 0">
             請勾選要列印的資源，從右側欄中勾選。
        </li>

      </ol>

    </div>

</div>



</body>

<script type="text/javascript">

  $(document).ready(function(){
    console.log(navigator.userAgent);
  });

  
  var listApp = new angular.module("listApp", []);

  listApp.filter('makeQR',function(){
  	return function(str){
  		return str.replace('https://','').replace('http://','');
  	}
  }).filter('makeMoe',function(){
    return function(x){      
      return encodeURIComponent(x.replace(/ /g, '　').replace(/[ -~]/g, function(it){ return String.fromCharCode(it.charCodeAt(0) + 0xFEE0); }))
    }
  }).filter('makeCharList',function(){
    return function(str) {
      var ans = [];
      for (var i = 0; i < str.length; i++) {
        ans.push(str.substr(i,1));
      };
      return ans;
    }
  }).filter('checked',function(){
    return function(objs) {
      var list = [];
        for (var i = 0; i < objs.length; i++) {
           if (objs[i].checked) list.push(objs[i]);
         }; 
      return list;
    }
  }).filter('limitTag',function(){
    return function(str, lim) {
      if (lim < 0) lim = 0;
      var tags = str.split(' ');
      return tags.slice(0,lim).join(' ');
    }
  }).filter('useKey',function(){
    return function(objs, key, inv) {

      if (!key) return objs;

      var keys=[];
      try {keys = key.split(' ')} catch(err){console.log(err)};
      var list = [], others = [];
      var min = 0, max = Infinity;
    
      for (var i = 0; i < objs.length; i++) {

          var good = true;
              
          for (var j = 0; j < keys.length; j++) {
              var thisGood = false;
              var akey = keys[j];
              var akeys = akey.split('/');

              for (var k = 0; k < akeys.length; k++) {
                var ke = akeys[k];

                try {
                  min = objs[i].tags.match(/\d+/g)[0];        
                  max = objs[i].tags.match(/\d+/g)[1] ? objs[i].tags.match(/\d+/g)[1] : Infinity;
                   console.log(min+'/'+max);
                } catch (err){ }

                if (min <= parseInt(ke) && parseInt(ke) <= max) {
                  thisGood = true;
                }
                if ( parseInt(ke) != ke && (objs[i].title + objs[i].url + objs[i].tags).indexOf(ke) > -1) thisGood = true;
                }              

              if (!thisGood) good = false;
             
          };

          if (good) { list.push(objs[i]) } else { others.push(objs[i]) };
      };

      
      return inv ? others : list;
    }
  })/*.filter('noKey',function(){
    return function(objs, no) {

      if (!no) return objs;

      var nos = [];
      try {nos = no.split(' ')} catch(err){console.log(err)};
      var list = [];
      var min = 0, max = Infinity;


      for (var i = 0; i < objs.length; i++) {
        
        var good = true;

        for (var j = 0; j < nos.length; j++) {
            var not = nos[j];

            try {
              min = objs[i].tags.match(/\d+/g)[0];        
              max = objs[i].tags.match(/\d+/g)[1] ? objs[i].tags.match(/\d+/g)[1] : Infinity;
               console.log(min+'/'+max);
            } catch (err){ console.log(err) }

           if ((objs[i].title + objs[i].url + objs[i].tags).indexOf(not) > -1
                || (min <= parseInt(not) && parseInt(not) <= max)) {
              good = false;
           };
        };

        if (good) list.push(objs[i]);
      };
      return list;
    }
  })*/.filter('addQuote',function(){
    return function(str) {      
      return str ? '('+str+')' : '';
    }
  }).filter('sortByOrd',function(){
    return function(objs) {      
      return objs.sort(function(a,b){return a.ord-b.ord});
    }
  })
  ;

  function Ctrl ($scope) {

//    $scope.Math = window.Math;
//    $scope.$ = jQuery;

    $scope.counter = 0;
    $scope.gifts = [];
    $scope.lrList = ["learning_resouces.csv", "l_r_paid.csv"];
    $scope.metaList = ["local_taiwan", "special_edu"];
    $scope.tags =[];  // $scope.tags = [{t: '數學', n: 3}, {t: '科學', n: 6}];
    $scope.ageIndex = [0,0,0,0,1,1,3,4,5,6,7,5,0,0,0];
    $scope.ages = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,25,30,40,50,60,70,80,90,'無限'];

    $scope.local_taiwan = []; 
    $scope.special_edu = []; 

    $.ajax({
    type: "GET",    url: 'local_taiwan.txt',    dataType: "text",
        success: function(data) {
          $scope.readTxt(data,'local_taiwan');
          $scope.$digest();

          console.log($scope.local_taiwan);
        }
    });

    $.ajax({
        type: "GET",     url: 'special_edu.txt',   dataType: "text",
            success: function(data) {
              $scope.readTxt(data,'special_edu');
              $scope.$digest();

              console.log($scope.special_edu);
            }
    });

    for (var i = 0; i < $scope.lrList.length; i++) {      
        $.ajax({
        type: "GET",
        url: $scope.lrList[i],
        dataType: "text",
            success: function(data) {
              $scope.gifts = $scope.gifts.concat($scope.processData(data));
              $scope.tags = $scope.processTags(data, $scope.tags);
              
        /*      var newIndex = $scope.processAges(data);

              for (var i = 0; i < $scope.ageIndex.length; i++) {
                $scope.ageIndex[i] += newIndex[i]
              };
                */
              
              $scope.$digest();
            }
         });
    };


    $scope.readTxt = function(allText, name) {
          var ans = [];
          var allTextLines = allText.split(/\r\n|\n/); 

          for (var i=0; i<allTextLines.length; i++) {
              if (allTextLines[i].split('/')[1]) {
                ans.push(allTextLines[i].replace(/\s/g, ''));
              }
              else if (allTextLines[i].substr(0,1) == '【' ) {
                ans.push(allTextLines[i].split('【')[1].split('】')[0]);
              }
          }

        console.log(ans);
        $scope[name] =  ans;
    }

    $scope.processData = function(allText) {
        var ans = [];
        var allTextLines = allText.split(/\r\n|\n/); 
        var headers = allTextLines[0].split(',');

        for (var i=1; i<allTextLines.length; i++) {
            var data = allTextLines[i].split(',');
            if (data.length == headers.length) {

                ans.push({
                    title: data[0],
                    url: data[1],
                    tags: data[2]
                });
            }
        }
   //     console.log(ans);
        return ans;
    }

    $scope.processTags = function(allText, oldTags) {
        var ansRow = new Object;
        var ans = [];

        if (oldTags) {
          for (var i = 0; i < oldTags.length; i++) {
              if (!ansRow[oldTags[i].t]) ansRow[oldTags[i].t] = 0;
              ansRow[oldTags[i].t] += oldTags[i].n;
          };
        }

        var allTextLines = allText.split(/\r\n|\n/); 
        var headers = allTextLines[0].split(',');

        for (var i=1; i<allTextLines.length; i++) {
            var data = allTextLines[i].split(',');

            if (data.length == headers.length) {

                var tags = data[2].split(' ');

                 console.log(tags.join());

                for (var j = 0; j < tags.length; j++) {
                    if (!(ansRow[tags[j]])) ansRow[tags[j]] = 0;
                    ansRow[tags[j]] += 1;

                };                
            }
        }

        for (var i = 0; i < Object.keys(ansRow).length; i++) {
           ans[i] = {t: Object.keys(ansRow)[i],
                     n: ansRow[Object.keys(ansRow)[i]]};
        };

        return ans;

    }

  };


</script>


</html>
