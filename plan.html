

<!-- backbround image colored bots -->

<!-- li icons before -->



<!DOCTYPE html>
<html ng-app = "editApp">

<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="javascripts/lib/angular.min.js"></script>

<script src='https://cdn.firebase.com/v0/firebase.js'></script>
<script src='https://cdn.firebase.com/libs/angularfire/0.5.0/angularfire.min.js'></script>


<meta charset=utf-8 />

<title>計畫小幫手--協力完成自學計畫</title>


<link rel="stylesheet" href="stylesheets/editor.css" />

<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css">


<style>


</style>

</head>




<body ng-controller = "Ctrl" ng-keydown = "maybeSave($event)">

  <audio id ="easy" controls autoplay class = 'noPrint'>
    <source src="voice/easy.mp3" type="audio/mpeg">
    <source src="voice/easy.ogg" type="audio/ogg">
  </audio>



<div id = 'headInfos' class = 'noPrint'>


  <a id = 'unlock' ng-click = 'save()' ng-show = 'lock && !sandbox'>已上鎖</a>
  <a id = 'lock' ng-click = 'lock = true' ng-show = '!lock && !sandbox'>已解鎖</a>
  <span id = 'status' ng-show = 'sandbox'>沙盒</span>


  使用者：
  <input ng-model = 'name'  ng-init = "chName(name)" ng-keypress = "mayBeChName($event, name)"/>
 <!-- 密碼(Password)：<input type = 'password' ng-model = 'password' /> -->
  
  <a id = 'go' ng-click = 'chName(name)'>Go!</a>


<!--
  <a id = 'create' ng-click = 'create' ng-hide = 'logged'>創建帳號</a>
  <a id = 'delete' ng-click = 'create' ng-show = 'logged'>刪除帳號</a>
-->
<!--
  <span id = 'status' ng-show = '!lock && !sandbox'>可直接儲存</span>
  <span id = 'status' ng-show = 'lock && !sandbox'>輸入密碼才可儲存</span>
-->

  <span id = 'lastTime' ng-bind = "'上次存檔: '+(root.data.time | localTime)"> </span>
  
  <span id = 'remTime' ng-bind = "'___尚餘'+(root.data.time | countTime:delay:clock | showRemTime)"></span>

  <a id = "info"
      onclick = "
      	if (confirm('非營利專案^_^\n\n儲存空間為Firebase服務\n\n免費版容量有限(所有用戶共100MB)\n\n請珍惜使用\n\n放置不用將於期限後刪除\n\n每次存檔，即可延長期限至99天後\n\n常用就不受影響喔^_^')) window.open('https://www.firebase.com/pricing.html')">
       ?  </a> 

</div>


<div id = 'headPlans' class = 'noPrint'>

  <span ng-repeat = 'n in [0,1,2,3,4,5,6,7,8,9,10,11]'>

    <a class = "{{$parent.planNow == n && 'focus'}}" ng-click = '$parent.planNow = n; quite();' ng-bind = "root.data.t[n].title || n+1">
      
    </a>

  </span>

</div>


<div id = 'leftPages' class = 'noPrint'>

  <ul>
    <li ng-repeat = "k in ['自傳', '學習風格','學習主題與領域','一週節奏','進度與目標','學習支持與資源','希望支援']" class = "{{$parent.pgNow == k && 'focus'}}" ng-mouseover = '$parent.pgNow = k;quite()'> 

      <img src="img/leaf-yellow.png" class = "leaf" ng-show = "pgNow == k"/>
      <img src="img/leaf-shadow.png" class="leaf shadow"/> 

      <br/>

      <span ng-bind = "name + '的' + k"></span>
      
      </li>
  </ul>

</div>

<!---->


<div id = 'rightSupports' class = 'noPrint'>

<br>
<h3 ng-bind = "pgNow">每頁都有不同的資源</h3>
的參考資源：
  <hr>
<ul>
	<li ng-repeat = "sup in supports | has:pgNow | invis:pgNow " ng-click = "op(sup.split(' ')[1])" ng-mouseover = "$parent.pop = true; $parent.popURL = sup.split(' ')[1]">

      <img src="img/leaf-green.png" class="leaf" />
      <img src="img/leaf-shadow.png" class="leaf shadow"/>

      <br/>

    {{sup.split(' ')[0]}}
</ul>

</div>


<div id = 'main' >

  <input
   ng-model = "root.data.t[planNow].title"
   placeholder = "自訂標題">
    

  <span id = 'status' ng-show = 'updated'>所有更動已儲存</span>
  <span id = 'status' ng-hide = 'updated'>等待儲存...按Ctrl+S儲存</span>
  <span id = 'status' ng-show = 'justDeleted'>本頁已刪除</span>

  <div id ='page1' ng-show = "pgNow == '自傳'">


    <div id = "timeline" class = "draw noSelect">

      <div ng-repeat = "y in ys">

        <div ng-repeat = "x in xs" class = "px" style = "

          top : {{y*10}}px; left : {{x*10}}px;

          background-color: {{
           (root.data.t[planNow].timeline[y][x] && 'rgb(' + (50 + x*3) + ',' + (255 - y *10 - x*3) + ',50)' ) || '#cfc' }} ;

        " ng-mouseover = "draw($event,y,x,planNow,colorNow)"

          ng-dblclick = "resetDraw(planNow)"

        >
          
          &nbsp;

        </div>

      </div>

      <div style = "position:absolute; top:102px;left:60px"> 幼年 </div>
      <div style = "position:absolute; top:102px;left:180px"> 小學 </div>
      <div style = "position:absolute; top:102px;left:420px"> 國中 </div>
      <div style = "position:absolute; top:102px;left:520px"> 高職/高中 </div>
      <div style = "position:absolute; top:102px;left:660px"> 社會/大學 </div>
    </div>


    <hr>
	  <textarea rows= '22' cols = '52' ng-model = "root.data.t[planNow]['自傳']"  

    ng-focus = " root.data.t[planNow]['自傳'] = hintToNull(root.data.t[planNow]['自傳']) "

    ng-blur = "root.data.t[planNow]['自傳'] = root.data.t[planNow]['自傳'] || hintData.t[planNow]['自傳'] "
    >


    </textarea>
  </div>

  <div id ='page2' ng-show = "pgNow == '學習風格'">

	  <textarea rows= '12' cols = '30'
    ng-model = 'root.data.t[planNow]["學習風格"]'
    ng-focus = " root.data.t[planNow]['學習風格'] = hintToNull(root.data.t[planNow]['學習風格']) "
    ng-blur = "root.data.t[planNow]['學習風格'] = root.data.t[planNow]['學習風格'] || hintData.t[planNow]['學習風格'] "

    > </textarea>

  </div>



  <div id ='page3' ng-show = "pgNow == '學習主題與領域'">

    <audio id ="topic" controls>
            <source src="voice/topic.mp3" type="audio/mpeg">
            <source src="voice/topic.ogg" type="audio/ogg">
    </audio>

    <br/>

    <textarea rows = "3" cols = "20"
     ng-model = "addTopic" ng-keydown = "adTPC($event)" placeholder = "寫上新主題，再按Enter新增"> </textarea>

<!--  <a ng-click= "adTPC($event)">增加主題</a> -->

      <span ng-repeat = "t in root.data.t[planNow]['主題']"> <a id = "x" ng-click = "root.data.t[planNow]['主題'] = removeElem(root.data.t[planNow]['主題'], t)">{{t}}</a></span>

      <br>
          
      <span id = "x" onclick = "$(this).fadeOut()" onmouseover = "$('#topic').trigger('play')">
        <ul>
          <li>您的學習主題可以自訂好幾項，範圍不限。
          <li>例如修車、養昆蟲、寫程式、打籃球、繪畫...都可以。
          <li>先想自己要做什麼，再去和課綱上的七大領域，對照打勾，看看是不是都有。
          <li>如果同一個主題，和許多領域都有關，可以在一行中，打好幾個勾。</ul> </span>

      <hr>

        <table>
           <tr>
            <th>
            <span id = "status" ng-show = "count(root.data.t[planNow].correlation, sevenFields, root.data.t[planNow]['主題']) > 0">尚餘{{count(root.data.t[planNow].correlation, sevenFields, root.data.t[planNow]['主題'])}}個領域</span>

            <span id = "status" ng-hide= "count(root.data.t[planNow].correlation, sevenFields, root.data.t[planNow]['主題']) > 0">都對到了!!</span>
            </th>

            <th ng-repeat = "t in root.data.t[planNow]['主題']"> {{t}}</th>
           </tr>
           <tr ng-repeat = "a in sevenFields">
            <th>{{a}}</th>
              <td ng-repeat = "t in root.data.t[planNow]['主題']">
              	
<!--                <input type = "checkbox" ng-model ="root.data.t[planNow].correlation[a+t]"> -->

                <a id = "aCheckbox" class="{{root.data.t[planNow].correlation[a+t]}}" 
                 ng-click="root.data.t[planNow].correlation[a+t] = !root.data.t[planNow].correlation[a+t]">
                	{{(root.data.t[planNow].correlation[a+t] && '✓') || ' '}}
                </a>

                <span class= "clipOnly"> {{ root.data.t[planNow].correlation[a+t] && "✓" || ''}} </span>
           </tr>
        </table>
  </div>


  <div id ='page4' ng-show = "pgNow == '一週節奏'" >

   <table>
  		<tr>
  			<th></th>
  			<th ng-repeat = "d in ['日','一','二','三','四','五','六']">{{d}}</th>
  		</tr>

  		<tr ng-repeat = "j in ['清晨','早餐','早上','午餐','下午','晚餐','晚上','深夜']">

  			<th>
  				{{j}}
  			</th>

  			<td ng-repeat = "d in ['日','一','二','三','四','五','六']">


  				<select ng-model = "root.data.t[planNow].schedule[d+j]"  value="{{root.data.t[planNow].schedule[d+j]}}">

  					<option ng-repeat = "tp in root.data.t[planNow]['主題']"
                    ng-selected="{{tp == root.data.t[planNow].schedule[d+j]}}"
                    value="{{tp}}">
                    {{tp}}
            </option>

  					<option value="彈性">彈性</option>
            <option value="休息">休息</option>

  				</select>

  				<span ng-show = "j == '早上' || j == '下午'">

  				<br>

  				<select
  					ng-model = "root.data.t[planNow].schedule[d+j+'b']" >
  					<option ng-repeat = "tp in root.data.t[planNow]['主題']"
                    ng-selected="{{tp == root.data.t[planNow].schedule[d+j]}}"
                    value="{{tp}}">{{tp}}</option>
                    
  					<option value="彈性">彈性</option>
            <option value="休息">休息</option>
  				</select>

  				</span>


  			</td> 			
  		</tr>
  		
  	</table>

    你不一定要只在家裡或社區，自學生也可以規畫一部份時間，在學校上課。
    不僅可以規畫在原本的學校上課，也可以去任何一所公立大學旁聽。政府的政策是，所有公立大學都開放旁聽。

  </div>


  <div id ='page5' ng-show = "pgNow == '進度與目標'">

   <select ng-model = "timeT" ng-init = "timeT = 'm'">
	   	<option value="m">月進度</option>
<!--  	   	<option value="y">年進度</option>  -->
<!--	    <option value="w">週進度</option> -->
   </select>

   <input type="number" ng-model = "root.data.t[planNow].shift"/>

   <table>
  		<tr>
  			<th></th>
  			<th ng-repeat = "tp in root.data.t[planNow]['主題']">{{tp}}</th>
  		</tr>

      <tr>
        <th>評量方式</th>
        <td ng-repeat = "tp in root.data.t[planNow]['主題']">
          
            <span style = "color:green" ng-repeat = "m in ['內省','檔案','作品','行動','老師評量','家長評量','紙筆考試']">
               
              {{m}}

              <a id = "aCheckbox" class="{{root.data.t[planNow].checkGoal[tp+m] }}" 
               ng-click="root.data.t[planNow].checkGoal[tp+m] = !root.data.t[planNow].checkGoal[tp+m]">
                	{{(root.data.t[planNow].checkGoal[tp+m] && '✓') || ''}}
                </a>

              <span class = "clipOnly"> {{ root.data.t[planNow].checkGoal[tp+m] && "✓" || ''}} </span>

              <br>

            </span>
          <ul>
        </td>
      </tr>

  		<tr ng-repeat = "j in calanD[timeT] | shifted:root.data.t[planNow].shift">

  			<th>
  				{{j}}
  			</th>

  			<td ng-repeat = "tp in root.data.t[planNow]['主題']">

          {{tp + j}}
        
        <br>

  			<textarea cols="4" rows="8" 
  				ng-model = "root.data.t[planNow].goal[tp+j]"
  				   onfocus="$(this).attr('cols', 8)"
 				     onblur="$(this).attr('cols', 4)" 
  				   placeholder= "我給自己的目標">

				</textarea>  				

        <br>

         <input type = "checkbox" ng-model = "root.data.t[planNow].checkGoal[tp+j]" />
         
        <span class = "clipOnly"> {{ root.data.t[planNow].checkGoal[tp+j] && "✓" || ''}} </span>


          成功

  				
  			</td> 			
  		</tr>
  		
  	</table>
  </div>


  <div id ='page6' ng-show = "pgNow == '學習支持與資源' ">

    <ul>
      <li>你不一定要只在家裡或社區，自學生也可以規畫一部份時間，在學校上課。
      <li>不僅可以規畫在原本的學校上課，也可以去任何一所公立大學旁聽。
      <li>政府的政策是，所有公立大學都開放旁聽。
    </ul>

    <hr>

  	<table>
  		<tr>
        <th></th>
        <th ng-repeat = "tp in root.data.t[planNow]['主題']">{{tp}}</th></tr>

  		<tr ng-repeat = "j in ['教師','諮詢者','教材','同學','空間','社團','課程']">

        <th> {{j}} </th>

  			<td ng-repeat =  "tp in root.data.t[planNow]['主題']">
          {{tp + j}}

          <br>

  				<textarea cols="4" rows="8"

          ng-model = "root.data.t[planNow].resources[tp + j]"

             onfocus="$(this).attr('cols', 8)"
             onblur="$(this).attr('cols', 4)" 
             placeholder= "{{ hintSupports[j].replace('t', tp) }}">

          </textarea>

  			</td>

  		</tr>

  	</table>


  </div>

 <div id ='page7' ng-show = "pgNow == '希望支援' ">

    <ul>
      <li>自學生也具有正式的學生身份。
      <li>您可以部份時間到學校上課。
      <li>您可以使用學校的設備。
      <li>您可以使用政府公家單位的教育資源，例如圖書館和博物館。
    </ul>

    <hr>

      <textarea rows= '12' cols = '30'
      ng-model = 'root.data.t[planNow].callHelp'

      ng-focus = " root.data.t[planNow].callHelp = hintToNull(root.data.t[planNow].callHelp) "

      ng-blur = "root.data.t[planNow].callHelp = root.data.t[planNow].callHelp || hintData.t[planNow].callHelp "> </textarea>

      </td>

      </tr>

    </table>


  </div>


</div>


<div id='popup-content' popup='popURL' ng-show = "pop" ng-mouseout = "pop = false">

  <iframe id ="myframe" width = "100%" height = "100%">

  </iframe>

</div>






</body>


<script type="text/javascript">

$(document).ready(function(){
  
  $('.noSelect').disableSelection();


});

  var ctt = function(t,p,clock){
      return t + p*1000*60*60*24 - clock; 
  }

  var timeToDay = function(t) {
    return Math.floor(t / (1000*60*60*24));
  }



  var editApp = new angular.module('editApp',["firebase"]);
  editApp.filter('has',function(){
  	return function(list, x){
//  		console.log(x);
  		return list.filter(function(str){return (str.indexOf(x) > -1) || (str.indexOf('all') > -1) })
  	}
  }).filter('invis',function(){
    return function(list, x){
//      console.log(x);
      return list.map(function(str){return str.replace(x+',', '').replace('all,', '')});
    }
  }).filter('shifted',function(){
    return function(list, x){
    	var ans = [];
    	var m = list.length;
    	for (var i = 0; i < m; i++) {
    		var k = (x+i-1) % m;
    		ans.push(list[k]);
    	};
	    return ans;
    }
  }).filter('localTime',function(){
    return function(t){      
      	var d = new Date(t);
      	l = d.toLocaleString();
  	    return t ? l.replace(/\[.*\]/,'') : "未創建";
    }
  }).filter('countTime',function(){
    return ctt;
  }).filter('showRemTime',function(){
    return function(t){

	    return t ? timeToDay(t) +"天^_^" : "很多時間^_^";
    }
  }).directive('popup', function() {
  var p = {
      link : function(scope, iElement, iAttrs){
           //code to wrap the div (iElement) with a abs pos div (parentDiv)
          // code to add a mask layer div behind 
          // if the parent is already there, then skip adding it again.
         //use jquery ui to make it dragable etc.
          scope.$watch(iAttrs.popup, function(newVal, oldVal){
               if(newVal){
       //            $(iElement).show();
                   console.log(newVal);
                   $('#myframe').attr('src', newVal);
                 } 
              else{
         //        $(iElement).hide();
                }
          });
      }


   }
  return p;
});

  initData = new Object;
  initData.t = new Array;
      for (var inn = 0; inn < 12; inn++) {

         initData.t[inn] = new Object;

         initData.t[inn]['自傳'] = '小幫手：先照著你想到的去寫你的成長故事以及自我介紹\n\n再對應到申請書的「個性描述」「平時興趣」「健康狀況」「學習態度」「家庭成員」「家庭成員」「人際互動」「特殊表現」「其他方面」';

         initData.t[inn]['學習風格'] = '小幫手：現代的教育研究者發現，每個人擅長的學習方法都不同\n\n你最擅長怎樣的在學習情摬中，用什麼樣的學習節奏，和誰一起，學習新事物呢?';


         initData.t[inn].callHelp = '小幫手：你不孤單。很多人都願意伸手，只要你懂得在需要時向對的人求助。';
        
        initData.t[inn].correlation = {
            '健康與體育運動' : true,
            '綜合活動生活自理' : true
        };

        initData.t[inn].schedule = {
         '日清晨':'彈性',
         '一清晨':'運動',
         '二清晨':'運動',
         '二清晨':'運動',
         '四清晨':'運動',
         '五清晨':'運動',
         '六清晨':'彈性',
         '日早餐':'生活自理', 
         '日午餐':'生活自理', 
         '日晚餐':'生活自理', 
         '日深夜':'休息', 
         '一深夜':'休息',
         '二深夜':'休息',
         '三深夜':'休息', 
         '四深夜':'休息',
         '五深夜':'休息',
         '六深夜':'休息',
        };

        var dd = new Date;
        initData.t[inn].shift = dd.getMonth() + 1;

        initData.t[inn].goal = {};

        initData.t[inn].checkGoal = {};

        initData.t[inn].resources = {};
        
        initData.t[inn]['主題'] = ['生活自理','運動','收集資訊'];

        initData.t[inn].timeline = [
          [true],
          [true],
          [true],
          [true],
          [true],
          [true],
          [true],
          [true],
          [true],
          [true],
        ];

         for (var i = 0; i < 10; i++) {
  //          $scope.root.data.t[planNow].timeline[i][0] = true;

            for (var j = 1; j < 72; j++) {
              initData.t[inn].timeline[i][j] = false;
            };
          };

          initData.t[inn].timeline[8][12] = true;
          initData.t[inn].timeline[9][12] = true;

          initData.t[inn].timeline[8][36] = true;
          initData.t[inn].timeline[9][36] = true;

          initData.t[inn].timeline[8][48] = true;
          initData.t[inn].timeline[9][48] = true;

          initData.t[inn].timeline[8][60] = true;
          initData.t[inn].timeline[9][60] = true;


      };

  console.log(initData);

  var Ctrl = function ($scope, $firebase) {

  	setInterval(function(){
  		$scope.now = new Date;
  		$scope.clock = $scope.now.getTime();
	}, 1000);


  	$scope.confirm = window.confirm;
    $scope.console = window.console;
  	$scope.$ = jQuery;
    $scope.popURL = '';
    $scope.name = '您';
    $scope.lock = true;
    $scope.delay = 100; // 到期延後日


    if(location.hash) {$scope.name = decodeURI(location.hash.replace('#','')) }

    $scope.planNow = 0;
    $scope.pgNow = '自傳';


    $scope.hintSupports = { 教師 : "您要向誰學習t呢?",
                            諮詢者 : "t遇到問題，要向誰求助?",
                            教材 : "用哪些教材學習t?",
                            同學 : "和誰一起學習t?",
                            空間 : "您要在哪些地方學習t呢?",
                            社團 : "參加學習t的社團?",
                            課程 : "參加t課程?",

                          };

    $scope.sevenFields = ['語文-國文','語文-鄉土語文','語文-英文','健康與體育','社會','數學','自然與科技','藝術與人文','綜合活動'];

    $scope.calanD = {
	    //  w:[]
    	m: ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'],
    	y: ['今年','明年','後年','3年後','4年後','5年後','10年後','20年後']
    };

      $scope.clone = function(o) {
   
        var m = $.extend(true, {}, o);
 //       console.log("Cloning this"); 
   //     console.log(m);
     //   console.log("well done"); 

        return m;
      }

//      $scope.hint = $scope.clone(initData.t[0]);

      $scope.hintData = $scope.clone(initData);

      $scope.root = {};
      $scope.root.data = $scope.clone(initData);
      

    $scope.supports = [
    '全球化與自主學習(自傳,13分鐘_講座) http://www.youtube.com/embed/Mi7qkTyqimE',
    '各縣市自學申請表(自傳,_正式申請用的表格是這份喔!) http://law.chen-wernik.net',

    '學習風格自我測試(學習風格,7分鐘_自我探索) http://bestian.github.io/freemath/%E5%B7%A5%E5%85%B7%E8%BB%9F%E9%AB%94/styleTester.html',


    '七大領域的教學理念(學習主題與領域,3分鐘_瀏覽概要) http://163.24.138.110/jses/other/%E4%B8%83%E5%A4%A7%E9%A0%98%E5%9F%9F%E7%9A%84%E6%95%99%E5%AD%B8%E7%90%86%E5%BF%B5.html',

    '如何訂學習計畫_上(學習主題與領域,10分鐘_講座) http://www.youtube.com/embed/SUoT5P8_UOI',
    '如何訂學習計畫_中(學習主題與領域,10分鐘_講座) http://www.youtube.com/embed/2jF8Hu6aTCU',
    '如何訂學習計畫_下(學習主題與領域,10分鐘_講座) http:www.youtube.com/embed/yeWB3BhQ7lg',
    

    '如何成為未來職場需要的自由人才_上(進度與目標,10分鐘_講座) http://www.youtube.com/embed/ZPzqw3x05-g',
    '如何成為未來職場需要的自由人才_中(進度與目標,10分鐘_講座) http://www.youtube.com/embed/Yc-fHn5aevo',
    '如何成為未來職場需要的自由人才_下(進度與目標,10分鐘_講座) http://www.youtube.com/embed/IqQTLQH-S_M',

    '支持與資源分享(學習支持與資源,3分鐘_檢索) http://bestian.github.io/shackhand/list_printer.html',

    '自學2.0互認地圖(希望支援,7分鐘_認識附近的朋友) http://bestian.github.io/shackhand/auto20',

    '丙級技術師證照線上複習(希望支援,5分鐘_考古題) http://onlinetest.slhs.tp.edu.tw/test2/main/review_setup.asp?examid=testr',

    '乙級技術師證照線上複習(希望支援,5分鐘_考古題) http://onlinetest2.slhs.tp.edu.tw'

    ];

    $scope.resetDraw = function (planNow) {
      $scope.root.data.t[planNow].timeline = initData.t[0].timeline;
      $scope.updated = false

      /*

      for (var i = 0; i < 10; i++) {
        $scope.root.data.t[planNow].timeline[i][0] = true;

        for (var j = 1; j < 72; j++) {
          $scope.root.data.t[planNow].timeline[i][j] = false;
        };
      };

      $scope.root.data.t[planNow].timeline[8][12] = true;
      $scope.root.data.t[planNow].timeline[9][12] = true;

      $scope.root.data.t[planNow].timeline[8][36] = true;
      $scope.root.data.t[planNow].timeline[9][36] = true;

      $scope.root.data.t[planNow].timeline[8][48] = true;
      $scope.root.data.t[planNow].timeline[9][48] = true;

      $scope.root.data.t[planNow].timeline[8][60] = true;
      $scope.root.data.t[planNow].timeline[9][60] = true; */

    }

    $scope.draw = function (ev,y,x,planNow, colorNow) {
   //   console.log($scope.root.data.t[planNow]);

      if (!colorNow) colorNow = false;

      if (!$scope.root.data.t[planNow].timeline[y]) $scope.root.data.t[planNow].timeline[y] = [true];

      var depth = ((x % 12 || x == 0 || x == 24) && 10) || 8;

      for (var i = 0; i < depth; i++) {      
        $scope.root.data.t[planNow].timeline[i][x] = colorNow;        
      } 

      $scope.root.data.t[planNow].timeline[y][x] = !colorNow;
      $scope.updated = false; 
    }

    $scope.range = function (n) {
      var ar = [];
      for (var k = 0; k < n; k++) {
          ar[k] = k;
      }
      return ar;
    }

    $scope.ys = $scope.range(10);
    $scope.xs = $scope.range(72);


    $scope.removeElem = function(list, elem) {
       return list.filter(function(str){ return str.indexOf(elem) == -1})
    }

    $scope.adTPC = function(ev){
      if ((ev.keyCode && ev.keyCode != 13) || !$scope.addTopic) return;
      $scope.root.data.t[$scope.planNow]['主題'].push($scope.addTopic);
      $scope.addTopic = '';
    }

    $scope.count = function(table, set1, set2) {


      var ans = set1.length;

      function satis(elem) {
        var a = false;
        for (var i = 0; i < set2.length; i++) {
          if (table[elem+set2[i]]) a = true;
        };
        return a;

      }
      for (var i = 0; i < set1.length; i++) {
        if (satis(set1[i])) ans -= 1;
      };

      return ans;
    }

    $scope.quite = function() {
      $("audio").each(function(){
          this.pause(); // Stop playing
          this.currentTime = 0; // Reset time
      }); 
    }

     $scope.hintToNull = function(str) {
      if (!str) return;
      return str.substr(0,4) == '小幫手：' ?  ''  : str;
    }

    $scope.op = function(url) {
      window.open(url);
    }


    $scope.maybeSave = function (event) {

        if (event.ctrlKey || event.metaKey) {
            switch (String.fromCharCode(event.which).toLowerCase()) {
              case 's':
                  event.preventDefault();
                  console.log('ctrl-s');
                  $scope.save();
          //        $scope.updated = true;
                  return;
                  break;
              case 'd':
                  event.preventDefault();
                  console.log('ctrl-d');
                  if (confirm("捨棄本次更新?")) $scope.overwrite();
              case 'r':
                  event.preventDefault();
                  console.log('ctrl-r');
                  if (confirm("清空資料，還原成範本?"))
                  $scope.root.data = initData;
                  $scope.$digest();
            }
        }

        $scope.updated = false;
    }

    $scope.createPassword = function(name) {
      var p1, p2;

      while (!p1 || p1 != p2) {
        p1 = prompt("歡迎" + name + "!!創建帳號，請設定一組密碼");
        p2 = prompt("請再輸入一次密碼以確認");

        if (!p1  || !p2) {
          alert("已取消")
          return;
        }

        if (p1 != p2) { alert("兩次密碼不同，請重新設定") } else { break }
      }

      alert("已成功設定密碼為"+p1+"!!\n請確實記下您的密碼，之後無法再查詢。");
      return p1 && p2;
    }

    $scope.save = function () {

      	if (!$scope.sandbox)  {

        	if ($scope.root.password) {

        		if ($scope.lock) {
			          var trypass = prompt("請輸入密碼以儲存變更");

			          if (trypass != $scope.root.password) {
			            alert("密碼不符");
			            return;
			          }

			          else {
			          	if (confirm("通過驗證，已解鎖!!要改密碼嗎?")){
			          		var newPass = $scope.createPassword($scope.name);
				            if (newPass) {
				              $scope.root.password = newPass;
				            } 
			          	}
			          }
		        }
	        }

	        else {
	            var newPass = $scope.createPassword($scope.name);
	            if (newPass) {
	              $scope.root.password = newPass;
	            } else {
                $scope.base.$remove();
	              return;
	            }
	        }
  	  	}
 	
	    var d = new Date;
	    console.log(d.getTime());
	    console.log($scope.root);

	    $scope.root.data.time = d.getTime();
	    $scope.base.$set($scope.root);
	    $scope.updated = true;
	    $scope.lock = false;


    }

    //NAME CHANGE
      $scope.mayBeChName = function(ev, n){

        if (ev.keyCode != 13 || !$scope.name) return;
        $scope.chName(n);

      }

      $scope.chName = function(newValue) {  

        console.log("I see a data change!" + newValue);

        $scope.updated = false;
        $scope.lock = true;

        $scope.sandbox = (/^(您|我|他|她)$/).test(newValue) ? true : false;

        location.hash = '#' + encodeURI(newValue);



        var ref = new Firebase('https://shackhand-plan.firebaseio.com/' + encodeURI(newValue));

      //  try {

      //    $scope.binding = false;

      //    $scope.base.$bind($scope, "root").then(function(unbind) {
      //      unbind();          // No changes have been made to the remote data.
      //    });

      //    console.log("unbinded");

      //  } catch (err) {
      //    console.log(err);
      //  }

        $scope.base = $firebase(ref);
        console.log($scope.base);

        //

        $scope.base.$on("loaded", function() {

          console.log("File Loaded!!");

          if (!$scope.binding) $scope.overwrite();

      /*    setTimeout( function() {

              if (!$scope.binding) {
                $scope.bind3w();
              } else {
                console.log("Already Binded");
              }
          }  , 1000 ); */

        });

        //


        $scope.base.$on("change", function() {
          
          if (!$scope.binding) {
            console.log("A remote change was applied locally!");
            $scope.overwrite();

          }
          else {
            console.log("binding");
          }

        });
       
    }

    $scope.updateInit = function(){
      console.log('updating from Init');
      var ks = Object.keys(initData.t[0]);
    //  console.log(ks);

      for (var i = 0; i < ks.length; i++) {
        var k = ks[i];
    //    console.log(k);
        for (var j = 0; j < 12 ; j++) {
     //       console.log(j);
            if (typeof($scope.root.data.t[j]) == 'undefined') {
              $scope.root.data.t[j] = new Object;
              $scope.root.data.t[j] = initData.t[j];
            }
            if (typeof($scope.root.data.t[j][k]) == 'undefined') {
              $scope.root.data.t[j][k] = initData.t[j][k];
              console.log(k + ':updated 1 item:' + initData.t[j][k] + ' from Init');
            }        
        };
      };

    }

    $scope.overwrite = function() {  

        console.log("Overwriting"); 

        $scope.root.data = $scope.clone($scope.base.data);

        try {
          $scope.root.password = $scope.base.password + "";

          if (!$scope.root.password.replace("undefined",'').replace("false",'')) {
              $scope.root.password = false;
          } else {  }

        } catch (err) {
          console.log(err);
        }

        // delete if outdated
        var t = $scope.root.data.time;
        var c = $scope.clock;
        var p = $scope.delay;

        console.log(timeToDay(ctt(t,p,c)));

        if (!ctt(t,p,c) || ctt(t,p,c) < 0 ) {
          $scope.root.data = $scope.clone(initData);
          $scope.root.password = false;
    //      alert("帳號超過"+p+"天未使用，已刪除。");
        }

        $scope.updateInit();

    }

    $scope.bind3w = function() {

              console.log("Begin Binding"); 
              console.log($scope.base);  
              console.log($scope.root);      
                    
      //        $scope.binding = true;
      //        $scope.updated = true;

              if (typeof($scope.root.data.t) == "undefined") {

                    console.log("Initializing");

                    $scope.base.$child("data").$set(initData);   // B

                    $scope.root = new Object;
                    $scope.root.data = $scope.clone(initData);   // M

                    console.log($scope.root);
                    console.log($scope.base);
                }
            

         //     $scope.base.$bind($scope, "root");   Problem: TOO LEG!!
              
   /*
              setInterval(function(){
                  
                  setTimeout(function(){

                    console.log($scope.root);

            //        $scope.base.$set($scope.root);

                  }, 10 + Math.floor(Math.random()*10));

              }, 1000);  */


    }

    

};

</script>

</html>
